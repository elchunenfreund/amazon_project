<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Products Management - Amazon Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 16px; }
        .hidden-row { display: none !important; }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #0f172a;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #000;
        }
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }
        .step.active {
            color: #3b82f6;
            font-weight: bold;
        }
        .step.completed {
            color: #10b981;
        }
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e2e8f0;
            line-height: 30px;
            margin-bottom: 5px;
        }
        .step.active .step-number {
            background: #3b82f6;
            color: white;
        }
        .step.completed .step-number {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">
    <div class="max-w-full mx-auto">
        <header class="sticky top-0 z-[100] bg-slate-100 pt-4 pb-4 -mx-4 md:-mx-8 px-4 md:px-8 flex flex-col lg:flex-row justify-between items-end mb-8 gap-6 shadow-lg">
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tight text-emerald-600">Products Management</h1>
                <p class="text-slate-500 font-bold italic">Manage ASINs and Import from Excel</p>
            </div>
            <div class="flex flex-wrap gap-2 md:gap-4 items-end">
                <a href="/" class="bg-slate-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-slate-700 active:scale-95 transition-all text-sm md:text-base">‚Üê DASHBOARD</a>
                <button onclick="openAddAsinModal()" class="bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-green-700 active:scale-95 transition-all text-sm md:text-base">+ ADD ASIN</button>
                <button onclick="openExcelUploadModal()" class="bg-indigo-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition-all text-sm md:text-base">üìä UPLOAD EXCEL</button>
                <button onclick="findDuplicates()" class="bg-amber-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-amber-700 active:scale-95 transition-all text-sm md:text-base">üîç FIND DUPLICATES</button>
                <button onclick="bulkDelete()" id="bulk-delete-btn" class="bg-rose-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-rose-700 active:scale-95 transition-all text-sm md:text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>DELETE SELECTED</button>
            </div>
        </header>

        <!-- Products Table -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            <div class="p-4 border-b border-slate-200">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div class="flex-1">
                        <input type="text" id="productSearchInput" onkeyup="filterProducts()" placeholder="Search ASINs..." class="px-4 py-2 rounded-xl border-2 border-slate-200 w-full md:w-64 outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="text-sm text-slate-500">
                        Total: <span id="productCount"><%= products.length %></span> products
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest">
                            <th class="p-4">
                                <input type="checkbox" id="selectAllProducts" onchange="toggleSelectAllProducts()" class="w-5 h-5 cursor-pointer">
                            </th>
                            <% columns.forEach(col => { %>
                                <th class="p-4"><%= col.name.toUpperCase() %></th>
                            <% }); %>
                            <th class="p-4">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody" class="divide-y divide-slate-100">
                        <% products.forEach((product, index) => { %>
                            <tr class="product-row hover:bg-slate-50" data-asin="<%= product.asin %>">
                                <td class="p-4">
                                    <input type="checkbox" class="product-checkbox w-5 h-5 cursor-pointer" value="<%= product.asin %>" onchange="updateBulkDeleteButton()">
                                </td>
                                <% columns.forEach(col => { %>
                                    <td class="p-4 text-base">
                                        <% if (col.name === 'asin') { %>
                                            <a href="https://www.amazon.ca/dp/<%= product[col.name] %>" target="_blank" class="font-mono text-blue-600 font-bold hover:underline"><%= product[col.name] %></a>
                                        <% } else { %>
                                            <%= product[col.name] || '-' %>
                                        <% } %>
                                    </td>
                                <% }); %>
                                <td class="p-4">
                                    <div class="flex gap-2">
                                        <button onclick="editProduct('<%= product.asin %>')" class="px-3 py-1 bg-blue-600 text-white text-xs font-black rounded hover:bg-blue-700">EDIT</button>
                                        <button onclick="deleteProduct('<%= product.asin %>')" class="px-3 py-1 bg-rose-600 text-white text-xs font-black rounded hover:bg-rose-700">DELETE</button>
                                    </div>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add ASIN Modal -->
    <div id="addAsinModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddAsinModal()">&times;</span>
            <div class="modal-header">Add New ASIN</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN (10 characters)</label>
                <input type="text" id="newAsinInput" placeholder="B08XYZ1234" maxlength="10" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
            </div>
            <div id="duplicateAsinWarning" class="hidden mb-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg">
                <div class="font-bold text-amber-900 mb-2">‚ö†Ô∏è ASIN Already Exists</div>
                <div class="text-sm text-amber-800 mb-3">This ASIN is already in your database. What would you like to do?</div>
                <div class="flex gap-2">
                    <button onclick="skipDuplicateAsin()" class="flex-1 bg-slate-400 text-white px-4 py-2 rounded-lg font-black hover:bg-slate-500 transition-all text-sm">Skip</button>
                    <button onclick="replaceDuplicateAsin()" class="flex-1 bg-amber-600 text-white px-4 py-2 rounded-lg font-black hover:bg-amber-700 transition-all text-sm">Keep Existing</button>
                </div>
            </div>
            <div class="flex gap-3">
                <button id="addAsinButton" onclick="addAsin()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Add ASIN</button>
                <button onclick="closeAddAsinModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
            <div id="addAsinError" class="mt-3 text-sm font-bold hidden"></div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="closeEditProductModal()">&times;</span>
            <div class="modal-header">Edit Product</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN:</label>
                <div id="editAsinDisplay" class="px-4 py-2 bg-slate-100 border-2 border-slate-300 rounded-lg text-base font-mono text-blue-600 font-bold"></div>
                <p class="text-xs text-slate-500 mt-1">ASIN cannot be changed</p>
            </div>
            <div id="editProductFields" class="space-y-4 mb-6">
                <!-- Fields will be dynamically generated here -->
            </div>
            <div class="flex gap-3">
                <button id="saveProductButton" onclick="saveProduct()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Save Changes</button>
                <button onclick="closeEditProductModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
            <div id="editProductError" class="mt-3 text-sm font-bold hidden"></div>
        </div>
    </div>

    <!-- Excel Upload Modal -->
    <div id="excelUploadModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeExcelUploadModal()">&times;</span>
            <div class="modal-header">Upload Excel File</div>

            <!-- Step 1: File Selection -->
            <div id="excelStep1" class="upload-step">
                <div class="step-indicator">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div>Select File</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>Import</div>
                    </div>
                </div>
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center">
                    <input type="file" id="productsExcelFileInput" accept=".xlsx,.xls,.csv,.numbers" class="hidden" onchange="handleProductsFileSelect(event)">
                    <label for="productsExcelFileInput" class="cursor-pointer">
                        <div class="text-4xl mb-4">üìä</div>
                        <div class="text-lg font-bold text-slate-700 mb-2">Click to select file</div>
                        <div class="text-sm text-slate-500">Supports Excel (.xlsx, .xls), CSV (.csv), and Numbers (.numbers - export to CSV/Excel first)</div>
                    </label>
                </div>
                <div id="productsFileInfo" class="hidden mt-4 p-4 bg-slate-100 rounded flex items-center justify-between">
                    <div class="font-bold">Selected: <span id="productsFileName"></span></div>
                    <button onclick="removeProductsFile()" class="bg-rose-600 text-white px-4 py-2 rounded-lg font-black hover:bg-rose-700 transition-all text-sm">Remove File</button>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="previewProductsExcel()" id="productsPreviewBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Preview & Continue</button>
                </div>
            </div>

            <!-- Step 2: Column Mapping -->
            <div id="excelStep2" class="upload-step hidden">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Select File</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>Duplicates</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div>Import</div>
                    </div>
                </div>
                <div id="productsColumnMappingContent">
                    <div class="mb-4 p-3 bg-slate-100 rounded flex items-center justify-between">
                        <div>
                            <span class="font-bold">File: </span>
                            <span id="productsMappingFileName"></span>
                        </div>
                        <button onclick="removeProductsFileAndGoBack()" class="bg-rose-600 text-white px-4 py-2 rounded-lg font-black hover:bg-rose-700 transition-all text-sm">Remove File</button>
                    </div>
                    <div class="mb-6">
                        <label class="block text-lg font-black text-slate-900 mb-2">Select ASIN Column</label>
                        <p class="text-sm text-slate-600 mb-3">Choose which column contains the ASIN values (10-character product identifiers)</p>
                        <select id="productsAsinColumnSelect" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg text-base focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all font-semibold"></select>
                    </div>
                    <div id="productsNewColumnsSection" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <label class="block text-lg font-black text-slate-900 mb-1">New Columns to Add</label>
                                    <p class="text-sm text-slate-600">Select which new columns to add to your database</p>
                                </div>
                                <button onclick="autoAddAllProductsNewColumns()" class="px-5 py-2.5 bg-green-600 text-white text-sm font-black rounded-lg hover:bg-green-700 shadow-md hover:shadow-lg transition-all">Auto-Add All</button>
                            </div>
                            <div id="productsNewColumnsList" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-lg font-black text-slate-900 mb-2">Map Excel Columns to Database</label>
                        <p class="text-sm text-slate-600 mb-4">Match your Excel columns to existing database columns. New columns are handled separately above.</p>
                        <div id="productsColumnMappingsList" class="space-y-2"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button onclick="goToProductsStep(1)" class="bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all">Back</button>
                    <button onclick="checkProductsDuplicates()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all">Check for Duplicates</button>
                </div>
            </div>

            <!-- Step 3: Duplicate Handling -->
            <div id="excelStep3" class="upload-step hidden">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Select File</div>
                    </div>
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">3</div>
                        <div>Duplicates</div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div>Import</div>
                    </div>
                </div>
                <div id="productsDuplicatesContent">
                    <div class="mb-4">
                        <div class="font-black text-lg text-slate-900 mb-2">Duplicate ASINs Found</div>
                        <p class="text-sm text-slate-600 mb-4">The following ASINs already exist in your database. Choose to replace or skip each one:</p>
                        <div id="productsDuplicatesList" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button onclick="goToProductsStep(2)" class="bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all">Back</button>
                    <button onclick="proceedWithProductsImport()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all">Continue to Import</button>
                </div>
            </div>

            <!-- Step 4: Import Results -->
            <div id="excelStep4" class="upload-step hidden">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Select File</div>
                    </div>
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Duplicates</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">4</div>
                        <div>Import</div>
                    </div>
                </div>
                <div id="productsImportResults" class="mt-4">
                    <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded relative">
                        <button onclick="closeExcelUploadModal()" class="absolute top-2 right-2 text-green-700 hover:text-green-900 font-bold text-xl">&times;</button>
                        <div class="font-bold mb-2">Import Complete!</div>
                        <div id="productsImportStats"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeExcelUploadModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all">Close</button>
                </div>
            </div>
            <div id="productsUploadError" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded"></div>
        </div>
    </div>

    <!-- Duplicate Cleanup Modal -->
    <div id="duplicateCleanupModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeDuplicateCleanupModal()">&times;</span>
            <div class="modal-header">Clean Up Duplicate Products</div>
            <div class="mb-4">
                <p class="text-sm text-slate-600 mb-4">The following ASINs appear multiple times. Select which entry to keep for each duplicate:</p>
                <div id="duplicateCleanupList" class="space-y-4 max-h-96 overflow-y-auto"></div>
            </div>
            <div class="flex gap-3">
                <button onclick="applyDuplicateCleanup()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Remove Selected Duplicates</button>
                <button onclick="closeDuplicateCleanupModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
            <div id="duplicateCleanupError" class="mt-3 text-sm font-bold hidden"></div>
        </div>
    </div>

    <script>
        // Excel Upload Variables
        let productsExcelFile = null;
        let productsPreviewData = null;

        // Excel Upload Functions
        function openExcelUploadModal() {
            document.getElementById('excelUploadModal').style.display = 'block';
            goToProductsStep(1);
        }

        function closeExcelUploadModal() {
            document.getElementById('excelUploadModal').style.display = 'none';
            removeProductsFile();
            productsPreviewData = null;
            goToProductsStep(1);
        }

        function goToProductsStep(step) {
            document.querySelectorAll('.upload-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`excelStep${step}`).classList.remove('hidden');
        }

        function handleProductsFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                productsExcelFile = file;
                document.getElementById('productsFileName').textContent = file.name;
                document.getElementById('productsFileInfo').classList.remove('hidden');
                document.getElementById('productsPreviewBtn').disabled = false;
                document.getElementById('productsUploadError').classList.add('hidden');
            }
        }

        function removeProductsFile() {
            productsExcelFile = null;
            productsPreviewData = null;
            document.getElementById('productsExcelFileInput').value = '';
            document.getElementById('productsFileName').textContent = '';
            document.getElementById('productsFileInfo').classList.add('hidden');
            document.getElementById('productsPreviewBtn').disabled = true;
            document.getElementById('productsUploadError').classList.add('hidden');
        }

        function removeProductsFileAndGoBack() {
            removeProductsFile();
            goToProductsStep(1);
        }

        async function previewProductsExcel() {
            if (!productsExcelFile) return;

            const formData = new FormData();
            formData.append('file', productsExcelFile);

            try {
                const response = await fetch('/api/upload-excel/preview', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    let errorMsg = data.error || 'Failed to preview file';
                    if (data.suggestion) {
                        errorMsg += '\n\n' + data.suggestion;
                    }
                    throw new Error(errorMsg);
                }

                productsPreviewData = data;
                if (productsExcelFile) {
                    document.getElementById('productsMappingFileName').textContent = productsExcelFile.name;
                }
                renderProductsColumnMapping();
                goToProductsStep(2);
            } catch (err) {
                const errorDiv = document.getElementById('productsUploadError');
                errorDiv.innerHTML = 'Error: ' + err.message.replace(/\n/g, '<br>');
                errorDiv.classList.remove('hidden');
            }
        }

        function renderProductsColumnMapping() {
            if (!productsPreviewData) return;

            // ASIN column select - show ALL columns
            const asinSelect = document.getElementById('productsAsinColumnSelect');
            asinSelect.innerHTML = '';
            productsPreviewData.excelColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.index;
                option.textContent = col.name;
                if (col.isAsin) {
                    option.selected = true;
                }
                asinSelect.appendChild(option);
            });

            // New columns section
            if (productsPreviewData.newColumns && productsPreviewData.newColumns.length > 0) {
                document.getElementById('productsNewColumnsSection').classList.remove('hidden');
                const newColsList = document.getElementById('productsNewColumnsList');
                newColsList.innerHTML = '';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-center mb-4 pb-3 border-b-2 border-slate-300';
                headerDiv.innerHTML = `
                    <div>
                        <div class="font-black text-lg text-slate-900">New Columns to Add</div>
                        <div class="text-sm text-slate-600 mt-1">${productsPreviewData.newColumns.length} column(s) will be added to your database</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectAllProductsNewColumns()" class="px-4 py-2 bg-blue-600 text-white text-sm font-black rounded-lg hover:bg-blue-700 shadow-md transition-all">Select All</button>
                        <button onclick="deselectAllProductsNewColumns()" class="px-4 py-2 bg-slate-400 text-white text-sm font-black rounded-lg hover:bg-slate-500 shadow-md transition-all">Deselect All</button>
                    </div>
                `;
                newColsList.appendChild(headerDiv);

                productsPreviewData.newColumns.forEach(col => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-4 bg-gradient-to-r from-slate-50 to-blue-50 border-2 border-slate-200 rounded-lg mb-2 hover:border-blue-300 transition-all';
                    div.innerHTML = `
                        <input type="checkbox" id="productsNewCol_${col.sanitizedName}" class="products-new-col-checkbox w-5 h-5 cursor-pointer" data-name="${col.name}" data-sanitized="${col.sanitizedName}" data-type="${col.suggestedType}" checked>
                        <label for="productsNewCol_${col.sanitizedName}" class="flex-1 cursor-pointer">
                            <div class="font-black text-slate-900 mb-1">${col.name}</div>
                            <div class="text-sm text-slate-600">
                                <span class="font-semibold">Database name:</span> <span class="font-mono text-blue-700">${col.sanitizedName}</span>
                                <span class="mx-2">‚Ä¢</span>
                                <span class="font-semibold">Type:</span> <span class="text-blue-700">${col.suggestedType}</span>
                            </div>
                        </label>
                    `;
                    newColsList.appendChild(div);
                });
            } else {
                document.getElementById('productsNewColumnsSection').classList.add('hidden');
            }

            // Column mappings - only show columns that are NOT new columns
            const mappingsList = document.getElementById('productsColumnMappingsList');
            mappingsList.innerHTML = '';

            const newColumnNames = new Set((productsPreviewData.newColumns || []).map(col => col.name.toLowerCase()));
            const columnsToMap = productsPreviewData.excelColumns.filter(col =>
                !col.isAsin && !newColumnNames.has(col.name.toLowerCase())
            );

            const suggestedMappings = productsPreviewData.suggestedMappings || {};
            let autoMatchedCount = 0;
            let unmatchedCount = 0;

            columnsToMap.forEach(col => {
                const hasMatch = suggestedMappings[col.name];
                if (hasMatch) autoMatchedCount++;
                else unmatchedCount++;
            });

            if (columnsToMap.length > 0) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl flex justify-between items-center shadow-sm';
                summaryDiv.innerHTML = `
                    <div class="text-sm">
                        <div class="font-black text-blue-900 text-base mb-1">Column Mapping Summary</div>
                        <div class="text-slate-700">
                            <span class="font-bold text-green-700">${autoMatchedCount} auto-matched</span>
                            ${unmatchedCount > 0 ? `<span class="text-slate-600"> ‚Ä¢ ${unmatchedCount} need manual mapping</span>` : '<span class="text-green-600"> ‚Ä¢ All columns mapped!</span>'}
                        </div>
                    </div>
                    <button onclick="autoMapAllProductsColumns()" class="px-5 py-2.5 bg-blue-600 text-white text-sm font-black rounded-lg hover:bg-blue-700 shadow-md hover:shadow-lg transition-all">Auto-Map All</button>
                `;
                mappingsList.appendChild(summaryDiv);
            }

            if (columnsToMap.length === 0) {
                const noMappingDiv = document.createElement('div');
                noMappingDiv.className = 'p-6 bg-slate-50 border-2 border-slate-200 rounded-xl text-center';
                noMappingDiv.innerHTML = `
                    <div class="text-4xl mb-3">‚úÖ</div>
                    <div class="font-bold text-slate-700 mb-1">All columns are new!</div>
                    <div class="text-sm text-slate-500">New columns will be added to the database above.</div>
                `;
                mappingsList.appendChild(noMappingDiv);
            } else {
                columnsToMap.forEach(col => {
                    const suggestedMatch = suggestedMappings[col.name];
                    const isAutoMatched = !!suggestedMatch;

                    const div = document.createElement('div');
                    div.className = `flex items-center gap-3 p-3 bg-white border-2 rounded-lg mb-2 transition-all ${isAutoMatched ? 'border-green-300 bg-green-50 shadow-sm' : 'border-amber-200 bg-amber-50 shadow-sm'}`;
                    div.innerHTML = `
                        <div class="flex-shrink-0">
                            ${isAutoMatched ? '<span class="text-green-600 text-xl">‚úì</span>' : '<span class="text-amber-600 text-xl">‚ö†</span>'}
                        </div>
                        <label class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-black text-slate-900">${col.name}</span>
                                ${isAutoMatched ? '<span class="text-xs text-green-700 font-bold bg-green-100 px-2 py-0.5 rounded">Auto-matched</span>' : '<span class="text-xs text-amber-700 font-bold bg-amber-100 px-2 py-0.5 rounded">Needs mapping</span>'}
                            </div>
                            <select class="products-column-mapping-select w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" data-excel-col="${col.name}">
                                <option value="">-- Skip this column --</option>
                                ${productsPreviewData.existingColumns.map(dbCol => {
                                    const isSelected = suggestedMatch === dbCol.name;
                                    return `<option value="${dbCol.name}" ${isSelected ? 'selected' : ''}>${dbCol.name}</option>`;
                                }).join('')}
                            </select>
                        </label>
                    `;
                    mappingsList.appendChild(div);
                });
            }
        }

        function selectAllProductsNewColumns() {
            document.querySelectorAll('.products-new-col-checkbox').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllProductsNewColumns() {
            document.querySelectorAll('.products-new-col-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }

        function autoMapAllProductsColumns() {
            if (!productsPreviewData || !productsPreviewData.suggestedMappings) return;

            const suggestedMappings = productsPreviewData.suggestedMappings;
            document.querySelectorAll('.products-column-mapping-select').forEach(select => {
                const excelCol = select.dataset.excelCol;
                const suggestedMatch = suggestedMappings[excelCol];
                if (suggestedMatch) {
                    select.value = suggestedMatch;
                }
            });
        }

        function autoAddAllProductsNewColumns() {
            const newColumns = productsPreviewData?.newColumns || [];
            if (newColumns.length === 0) {
                alert('No new columns to add');
                return;
            }

            if (confirm(`This will add ${newColumns.length} new column(s) to your database:\n\n${newColumns.map(c => `- ${c.name} (${c.suggestedType})`).join('\n')}\n\nContinue?`)) {
                selectAllProductsNewColumns();
            }
        }

        async function proceedWithProductsImport() {
            const asinColumnIndex = document.getElementById('productsAsinColumnSelect').value;
            if (!asinColumnIndex) {
                alert('Please select ASIN column');
                return;
            }

            try {
                document.getElementById('productsUploadError').classList.add('hidden');

                const formData = new FormData();
                formData.append('file', productsExcelFile);
                formData.append('asinColumnIndex', asinColumnIndex);
                formData.append('columnMappings', JSON.stringify(productsColumnMappings));
                formData.append('duplicateDecisions', JSON.stringify(productsDuplicateDecisions));

                // Debug: log duplicate decisions
                console.log('Sending duplicateDecisions:', productsDuplicateDecisions);

                const importResponse = await fetch('/api/upload-excel/import', {
                    method: 'POST',
                    body: formData
                });

                const importData = await importResponse.json();
                if (!importResponse.ok) {
                    throw new Error(importData.error || 'Failed to import data');
                }

                document.getElementById('productsImportStats').innerHTML = `
                    <div class="space-y-2">
                        <div class="font-bold text-lg mb-3">Import Results:</div>
                        <div class="flex items-center gap-2">
                            <span class="text-green-700 font-bold">‚úì Added:</span>
                            <span class="text-lg font-black">${importData.stats.added}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-blue-700 font-bold">‚Üª Updated:</span>
                            <span class="text-lg font-black">${importData.stats.updated}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-600 font-bold">‚äò Skipped:</span>
                            <span class="text-lg font-black">${importData.stats.skipped}</span>
                        </div>
                        ${importData.errors && importData.errors.length > 0 ?
                            `<div class="mt-3 p-3 bg-red-50 border border-red-300 rounded">
                                <div class="font-bold text-red-700">Errors: ${importData.errors.length}</div>
                                <div class="text-sm text-red-600 mt-1 max-h-32 overflow-y-auto">
                                    ${importData.errors.slice(0, 5).map(e => `<div>‚Ä¢ ${e}</div>`).join('')}
                                    ${importData.errors.length > 5 ? `<div>... and ${importData.errors.length - 5} more</div>` : ''}
                                </div>
                            </div>` : ''}
                    </div>
                `;
                goToProductsStep(4);
            } catch (err) {
                document.getElementById('productsUploadError').textContent = 'Error: ' + err.message;
                document.getElementById('productsUploadError').classList.remove('hidden');
            }
        }

        function sanitizeProductsColumnName(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9_]/g, '_')
                .replace(/_{2,}/g, '_')
                .replace(/^_|_$/g, '');
        }

        let productsDuplicateDecisions = {};
        let productsColumnMappings = {};
        let productsNewColumnsToAdd = [];

        async function checkProductsDuplicates() {
            const asinColumnIndex = document.getElementById('productsAsinColumnSelect').value;
            if (!asinColumnIndex) {
                alert('Please select ASIN column');
                return;
            }

            try {
                document.getElementById('productsUploadError').classList.add('hidden');

                // First, configure new columns if any
                const newColumnsToAdd = [];
                document.querySelectorAll('.products-new-col-checkbox:checked').forEach(cb => {
                    newColumnsToAdd.push({
                        name: cb.dataset.name,
                        type: cb.dataset.type
                    });
                });

                // Collect column mappings
                const mappings = {};
                document.querySelectorAll('.products-column-mapping-select').forEach(select => {
                    const excelCol = select.dataset.excelCol;
                    const dbCol = select.value;
                    if (dbCol) {
                        mappings[excelCol] = dbCol;
                    }
                });

                // Store for later use in import
                productsNewColumnsToAdd = newColumnsToAdd;
                productsColumnMappings = mappings;

                // Configure new columns if any
                if (newColumnsToAdd.length > 0) {
                    const configureResponse = await fetch('/api/upload-excel/configure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ columnsToAdd: newColumnsToAdd })
                    });

                    const configureData = await configureResponse.json();
                    if (!configureResponse.ok) {
                        throw new Error(configureData.error || 'Failed to configure columns');
                    }

                    // Update mappings with newly added columns
                    configureData.addedColumns.forEach(col => {
                        const excelCol = newColumnsToAdd.find(nc => sanitizeProductsColumnName(nc.name) === col.dbName);
                        if (excelCol) {
                            productsColumnMappings[excelCol.name] = col.dbName;
                        }
                    });
                }

                // Now check for duplicates
                const formData = new FormData();
                formData.append('file', productsExcelFile);
                formData.append('asinColumnIndex', asinColumnIndex);

                const response = await fetch('/api/upload-excel/check-duplicates', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to check duplicates');
                }

                if (data.duplicates.length === 0) {
                    // No duplicates, proceed directly to import
                    productsDuplicateDecisions = {};
                    await proceedWithProductsImport();
                    return;
                }

                // Show duplicates step
                productsDuplicateDecisions = {};
                const duplicatesList = document.getElementById('productsDuplicatesList');
                duplicatesList.innerHTML = '';

                data.duplicates.forEach(dup => {
                    const asinUpper = dup.asin.toUpperCase();
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-4 bg-amber-50 border-2 border-amber-200 rounded-lg';
                    div.innerHTML = `
                        <div class="flex-1">
                            <div class="font-black text-slate-900">ASIN: <span class="font-mono text-blue-600">${dup.asin}</span></div>
                            <div class="text-sm text-slate-600">Row ${dup.rowNum} in file</div>
                        </div>
                        <div class="flex gap-2">
                            <button data-asin="${asinUpper}" data-decision="replace" class="duplicate-decision-btn px-4 py-2 bg-green-600 text-white text-sm font-black rounded-lg hover:bg-green-700 transition-all duplicate-btn-${asinUpper}" data-decision="replace">Replace</button>
                            <button data-asin="${asinUpper}" data-decision="skip" class="duplicate-decision-btn px-4 py-2 bg-slate-400 text-white text-sm font-black rounded-lg hover:bg-slate-500 transition-all duplicate-btn-${asinUpper}" data-decision="skip">Skip</button>
                        </div>
                    `;
                    duplicatesList.appendChild(div);
                    // Default to skip - use uppercase ASIN to match import
                    productsDuplicateDecisions[asinUpper] = 'skip';
                    updateDuplicateButtonState(asinUpper, 'skip');
                });

                // Add event listeners to buttons
                document.querySelectorAll('.duplicate-decision-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const asin = this.dataset.asin;
                        const decision = this.dataset.decision;
                        setDuplicateDecision(asin, decision);
                    });
                });

                goToProductsStep(3);
            } catch (err) {
                document.getElementById('productsUploadError').textContent = 'Error: ' + err.message;
                document.getElementById('productsUploadError').classList.remove('hidden');
            }
        }

        function setDuplicateDecision(asin, decision) {
            // Store in uppercase to match import processing
            const asinUpper = typeof asin === 'string' ? asin.toUpperCase() : asin;
            productsDuplicateDecisions[asinUpper] = decision;
            console.log('Set duplicate decision:', asinUpper, '=', decision, 'Current decisions:', productsDuplicateDecisions);
            updateDuplicateButtonState(asinUpper, decision);
        }

        function updateDuplicateButtonState(asin, selectedDecision) {
            // Find buttons by data-asin attribute (uppercase)
            document.querySelectorAll(`[data-asin="${asin}"]`).forEach(btn => {
                if (btn.dataset.decision === selectedDecision) {
                    btn.classList.remove('bg-slate-400', 'bg-green-600');
                    btn.classList.add(selectedDecision === 'replace' ? 'bg-green-700' : 'bg-slate-500');
                    btn.style.opacity = '1';
                } else {
                    btn.classList.remove('bg-green-700', 'bg-slate-500');
                    btn.classList.add(selectedDecision === 'replace' ? 'bg-slate-400' : 'bg-green-600');
                    btn.style.opacity = '0.6';
                }
            });
        }

        // Product Management Functions
        function filterProducts() {
            const search = document.getElementById('productSearchInput').value.toLowerCase();
            const rows = document.querySelectorAll('.product-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const asin = row.getAttribute('data-asin').toLowerCase();
                if (asin.includes(search)) {
                    row.classList.remove('hidden-row');
                    visibleCount++;
                } else {
                    row.classList.add('hidden-row');
                }
            });

            document.getElementById('productCount').textContent = visibleCount;
        }

        function toggleSelectAllProducts() {
            const selectAll = document.getElementById('selectAllProducts');
            const checkboxes = document.querySelectorAll('.product-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateBulkDeleteButton();
        }

        function updateBulkDeleteButton() {
            const checked = document.querySelectorAll('.product-checkbox:checked').length;
            const btn = document.getElementById('bulk-delete-btn');
            btn.disabled = checked === 0;
        }

        async function bulkDelete() {
            const checked = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            if (checked.length === 0) return;

            if (!confirm(`Delete ${checked.length} product(s)?`)) return;

            try {
                for (const asin of checked) {
                    await fetch(`/api/asins/${asin}`, { method: 'DELETE' });
                }
                window.location.reload();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        let currentEditAsin = null;
        let dbColumnsForEdit = [];

        async function editProduct(asin) {
            currentEditAsin = asin;

            try {
                // Fetch current product data
                const response = await fetch(`/api/products/${asin}`);
                if (!response.ok) {
                    throw new Error('Failed to fetch product data');
                }
                const product = await response.json();

                // Get database columns (excluding ASIN and ID)
                if (dbColumnsForEdit.length === 0) {
                    const colsResponse = await fetch('/api/products/columns');
                    if (colsResponse.ok) {
                        const cols = await colsResponse.json();
                        dbColumnsForEdit = cols.filter(col => col.name !== 'asin' && col.name !== 'id');
                    }
                }

                // Display ASIN
                document.getElementById('editAsinDisplay').textContent = asin;

                // Generate form fields
                const fieldsContainer = document.getElementById('editProductFields');
                fieldsContainer.innerHTML = '';

                dbColumnsForEdit.forEach(col => {
                    const value = product[col.name] || '';
                    let inputHtml = '';

                    if (col.type === 'timestamp without time zone' || col.type === 'timestamp with time zone') {
                        // DateTime input
                        const dateValue = value ? new Date(value).toISOString().slice(0, 16) : '';
                        inputHtml = `<input type="datetime-local" id="edit_${col.name}" value="${dateValue}" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500">`;
                    } else if (col.type === 'boolean') {
                        // Checkbox
                        inputHtml = `<input type="checkbox" id="edit_${col.name}" ${value ? 'checked' : ''} class="w-5 h-5">`;
                    } else if (col.type === 'numeric' || col.type === 'double precision') {
                        // Number input
                        inputHtml = `<input type="number" step="any" id="edit_${col.name}" value="${value}" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500">`;
                    } else {
                        // Text input or textarea for longer text
                        const isLongText = col.name.toLowerCase().includes('comment') || col.name.toLowerCase().includes('note') || col.name.toLowerCase().includes('description');
                        if (isLongText) {
                            inputHtml = `<textarea id="edit_${col.name}" rows="4" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500">${value}</textarea>`;
                        } else {
                            inputHtml = `<input type="text" id="edit_${col.name}" value="${value}" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500">`;
                        }
                    }

                    const fieldDiv = document.createElement('div');
                    fieldDiv.innerHTML = `
                        <label class="block text-sm font-bold mb-2">${col.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</label>
                        ${inputHtml}
                    `;
                    fieldsContainer.appendChild(fieldDiv);
                });

                // Show modal
                document.getElementById('editProductModal').style.display = 'block';
                document.getElementById('editProductError').classList.add('hidden');
            } catch (err) {
                alert('Error loading product: ' + err.message);
            }
        }

        function closeEditProductModal() {
            document.getElementById('editProductModal').style.display = 'none';
            currentEditAsin = null;
        }

        async function saveProduct() {
            if (!currentEditAsin) return;

            const saveButton = document.getElementById('saveProductButton');
            const errorDiv = document.getElementById('editProductError');
            const originalText = saveButton.textContent;

            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            errorDiv.classList.add('hidden');

            try {
                const updateData = {};

                dbColumnsForEdit.forEach(col => {
                    const input = document.getElementById(`edit_${col.name}`);
                    if (!input) return;

                    let value;
                    if (col.type === 'boolean') {
                        value = input.checked;
                    } else if (col.type === 'timestamp without time zone' || col.type === 'timestamp with time zone') {
                        value = input.value ? new Date(input.value).toISOString() : null;
                    } else if (col.type === 'numeric' || col.type === 'double precision') {
                        value = input.value === '' ? null : parseFloat(input.value);
                    } else {
                        value = input.value.trim() || null;
                    }

                    updateData[col.name] = value;
                });

                const response = await fetch(`/api/asins/${currentEditAsin}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                if (response.ok) {
                    closeEditProductModal();
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Failed to update product';
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.add('text-red-600');
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
                errorDiv.classList.add('text-red-600');
                saveButton.disabled = false;
                saveButton.textContent = originalText;
            }
        }

        async function deleteProduct(asin) {
            if (!confirm(`Delete ASIN ${asin}?`)) return;

            try {
                const response = await fetch(`/api/asins/${asin}`, { method: 'DELETE' });
                if (response.ok) {
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to delete'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Add ASIN Modal
        function openAddAsinModal() {
            document.getElementById('addAsinModal').style.display = 'block';
            document.getElementById('newAsinInput').value = '';
            document.getElementById('addAsinError').classList.add('hidden');
        }

        function closeAddAsinModal() {
            document.getElementById('addAsinModal').style.display = 'none';
            document.getElementById('newAsinInput').value = '';
            document.getElementById('addAsinError').classList.add('hidden');
            document.getElementById('duplicateAsinWarning').classList.add('hidden');
            pendingDuplicateAsin = null;
        }

        let pendingDuplicateAsin = null;

        async function addAsin() {
            const asin = document.getElementById('newAsinInput').value.trim().toUpperCase();
            const errorDiv = document.getElementById('addAsinError');
            const duplicateWarning = document.getElementById('duplicateAsinWarning');
            const addButton = document.getElementById('addAsinButton');
            const originalText = addButton.textContent;

            if (!asin || asin.length !== 10) {
                errorDiv.textContent = 'ASIN must be exactly 10 characters';
                errorDiv.classList.remove('hidden');
                duplicateWarning.classList.add('hidden');
                return;
            }

            addButton.disabled = true;
            addButton.textContent = 'Checking...';
            errorDiv.classList.add('hidden');
            duplicateWarning.classList.add('hidden');

            try {
                const response = await fetch('/api/asins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asin })
                });

                const data = await response.json();
                if (data.exists) {
                    // ASIN already exists - show duplicate warning
                    pendingDuplicateAsin = asin;
                    duplicateWarning.classList.remove('hidden');
                    addButton.disabled = false;
                    addButton.textContent = originalText;
                } else if (response.ok && data.success) {
                    closeAddAsinModal();
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Failed to add ASIN';
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.add('text-red-600');
                    addButton.disabled = false;
                    addButton.textContent = originalText;
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
                errorDiv.classList.add('text-red-600');
                addButton.disabled = false;
                addButton.textContent = originalText;
            }
        }

        function skipDuplicateAsin() {
            document.getElementById('duplicateAsinWarning').classList.add('hidden');
            document.getElementById('newAsinInput').value = '';
            pendingDuplicateAsin = null;
        }

        async function replaceDuplicateAsin() {
            if (!pendingDuplicateAsin) return;

            const errorDiv = document.getElementById('addAsinError');
            const duplicateWarning = document.getElementById('duplicateAsinWarning');
            const addButton = document.getElementById('addAsinButton');

            addButton.disabled = true;
            addButton.textContent = 'Processing...';

            try {
                const response = await fetch('/api/asins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asin: pendingDuplicateAsin, replace: true })
                });

                const data = await response.json();
                if (response.ok) {
                    duplicateWarning.classList.add('hidden');
                    closeAddAsinModal();
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Failed to process ASIN';
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.add('text-red-600');
                    addButton.disabled = false;
                    addButton.textContent = 'Add ASIN';
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
                errorDiv.classList.add('text-red-600');
                addButton.disabled = false;
                addButton.textContent = 'Add ASIN';
            }
        }

        // Duplicate Cleanup Functions
        async function findDuplicates() {
            try {
                const response = await fetch('/api/products/duplicates');

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: Failed to find duplicates`);
                }

                const data = await response.json();

                if (data.duplicates.length === 0) {
                    alert('No duplicate ASINs found!');
                    return;
                }

                // Show duplicate cleanup modal
                const cleanupList = document.getElementById('duplicateCleanupList');
                cleanupList.innerHTML = '';

                data.duplicates.forEach((group, groupIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'p-4 bg-amber-50 border-2 border-amber-200 rounded-lg mb-4';
                    groupDiv.innerHTML = `
                        <div class="font-black text-lg text-slate-900 mb-3">ASIN: <span class="font-mono text-blue-600">${group.asin}</span> (${group.count} entries)</div>
                        <div class="space-y-2">
                            ${group.entries.map((entry, entryIndex) => `
                                <label class="flex items-center gap-3 p-3 bg-white border-2 rounded-lg cursor-pointer hover:bg-blue-50 transition-all">
                                    <input type="radio" name="duplicate-group-${groupIndex}" value="${entry.id}" ${entryIndex === 0 ? 'checked' : ''} class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                                    <div class="flex-1">
                                        <div class="font-bold text-slate-900">ID: ${entry.id}</div>
                                        <div class="text-sm text-slate-600 mt-1">
                                            ${Object.entries(entry).filter(([key, val]) => key !== 'id' && key !== 'asin' && val !== null && val !== '').slice(0, 5).map(([key, val]) => `<span class="mr-3"><strong>${key}:</strong> ${String(val).substring(0, 30)}</span>`).join('')}
                                        </div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    `;
                    cleanupList.appendChild(groupDiv);
                });

                document.getElementById('duplicateCleanupModal').style.display = 'block';
            } catch (err) {
                alert('Error finding duplicates: ' + err.message);
            }
        }

        function closeDuplicateCleanupModal() {
            document.getElementById('duplicateCleanupModal').style.display = 'none';
            document.getElementById('duplicateCleanupError').classList.add('hidden');
        }

        async function applyDuplicateCleanup() {
            try {
                const errorDiv = document.getElementById('duplicateCleanupError');
                errorDiv.classList.add('hidden');

                // Collect which entries to delete
                const entriesToDelete = [];

                document.querySelectorAll('#duplicateCleanupList > div').forEach((groupDiv, groupIndex) => {
                    const selectedRadio = groupDiv.querySelector(`input[name="duplicate-group-${groupIndex}"]:checked`);
                    if (selectedRadio) {
                        const keepId = parseInt(selectedRadio.value);

                        // Get all IDs in this group
                        const allRadios = groupDiv.querySelectorAll(`input[name="duplicate-group-${groupIndex}"]`);
                        allRadios.forEach(radio => {
                            const id = parseInt(radio.value);
                            if (id !== keepId) {
                                entriesToDelete.push(id);
                            }
                        });
                    }
                });

                if (entriesToDelete.length === 0) {
                    errorDiv.textContent = 'No duplicates selected for removal';
                    errorDiv.classList.remove('hidden');
                    return;
                }

                if (!confirm(`This will delete ${entriesToDelete.length} duplicate entr${entriesToDelete.length === 1 ? 'y' : 'ies'}. Continue?`)) {
                    return;
                }

                // Delete duplicates
                for (const id of entriesToDelete) {
                    const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });
                    if (!response.ok) {
                        throw new Error(`Failed to delete product ID ${id}`);
                    }
                }

                closeDuplicateCleanupModal();
                window.location.reload();
            } catch (err) {
                document.getElementById('duplicateCleanupError').textContent = 'Error: ' + err.message;
                document.getElementById('duplicateCleanupError').classList.remove('hidden');
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addAsinModal');
            const excelModal = document.getElementById('excelUploadModal');
            const editModal = document.getElementById('editProductModal');
            const duplicateModal = document.getElementById('duplicateCleanupModal');
            if (event.target === addModal) closeAddAsinModal();
            if (event.target === excelModal) closeExcelUploadModal();
            if (event.target === editModal) closeEditProductModal();
            if (event.target === duplicateModal) closeDuplicateCleanupModal();
        }
    </script>
</body>
</html>
