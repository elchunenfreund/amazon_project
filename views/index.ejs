<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Amazon Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 16px; }
        .hidden-row { display: none !important; }
        .terminal-scrollbar::-webkit-scrollbar { width: 4px; }
        .terminal-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .title-clamp { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        select.filter-select {
            background-color: #1e293b;
            color: white;
            font-size: 0.65rem;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 4px;
            margin-top: 4px;
            width: 100%;
            cursor: pointer;
            outline: none;
        }
        select.filter-select:hover { border-color: #94a3b8; }

        /* Sticky header */
        #inventoryTable thead {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #0f172a;
        }

        /* Sortable price header */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable-header:hover {
            background-color: #1e293b;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            font-size: 0.7rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #0f172a;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #000;
        }

        /* Snooze badge */
        .snooze-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #fbbf24;
            color: #78350f;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 4px;
        }
    </style>
</head>
<body class="bg-slate-100 p-8">
    <div class="max-w-full mx-auto">

        <div id="status-container" class="hidden mb-6 bg-slate-900 text-emerald-400 p-5 rounded-2xl border-l-8 border-emerald-500 font-mono text-xs shadow-2xl">
            <div class="flex justify-between items-center border-b border-emerald-900 pb-2 mb-2">
                <span class="font-black uppercase tracking-widest">Live Scraper Feed</span>
                <span id="sync-status" class="text-white font-bold bg-emerald-800 px-2 rounded">IDLE</span>
            </div>
            <div id="terminal-stream" class="h-40 overflow-y-auto terminal-scrollbar leading-relaxed"></div>
        </div>

        <header class="flex flex-col lg:flex-row justify-between items-end mb-8 gap-6">
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tight text-emerald-600">Inventory Dashboard</h1>
                <p class="text-slate-500 font-bold italic">Montreal / Outremont (H2V)</p>
            </div>
            <div class="flex gap-4 items-end">
                <div class="flex flex-col">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Search</label>
                    <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="ASIN or Title..." class="px-5 py-3 rounded-xl border-2 border-slate-200 w-64 outline-none focus:ring-2 focus:ring-blue-500 text-base">
                </div>

                <button onclick="openAddAsinModal()" class="bg-green-600 text-white px-6 py-3 rounded-xl font-black shadow-lg hover:bg-green-700 active:scale-95 transition-all text-base">+ ADD ASIN</button>

                <button onclick="runReportOnSelected()" id="run-selected-btn" class="bg-purple-600 text-white px-6 py-3 rounded-xl font-black shadow-lg hover:bg-purple-700 active:scale-95 transition-all text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>RUN ON SELECTED</button>

                <button onclick="runReport()" id="run-btn" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-black shadow-lg hover:bg-blue-700 active:scale-95 transition-all text-base">RUN ALL</button>
                <button onclick="stopReport()" id="stop-btn" class="hidden bg-rose-600 text-white px-8 py-3 rounded-xl font-black shadow-lg hover:bg-rose-700 active:scale-95 transition-all animate-pulse text-base">STOP</button>

                <div class="bg-white px-6 py-2.5 rounded-xl border border-slate-200 shadow-sm min-w-[160px]">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Last Report End</p>
                    <p id="last-sync-time" class="text-xl font-mono font-black text-blue-600"><%= lastSyncTime %></p>
                </div>
            </div>
        </header>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
            <table class="w-full text-left border-collapse" id="inventoryTable">
                <thead>
                    <tr class="bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest">
                        <th class="p-6">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-5 h-5 cursor-pointer">
                        </th>
                        <th class="p-6">#</th>
                        <th class="p-6">Status</th>
                        <th class="p-6">ASIN</th>
                        <th class="p-6 w-1/3">Product</th>

                        <th class="p-6 text-center w-48">
                            <div>STOCK STATUS</div>
                            <div class="relative inline-block w-full">
                                <button onclick="toggleStatusDropdown(event)" id="statusFilterBtn" class="filter-select w-full text-left px-3 py-2 flex items-center justify-between">
                                    <span id="statusFilterText">ALL</span>
                                    <span class="ml-auto">‚ñº</span>
                                </button>
                                <div id="statusDropdown" class="hidden absolute z-[200] w-full mt-1 bg-slate-800 border border-slate-700 rounded shadow-lg max-h-64 overflow-y-auto" style="top: 100%; left: 0;" onmousedown="(function(e){e.stopPropagation();fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:dropdown:mousedown',message:'Dropdown mousedown',data:{target:e.target.tagName,id:e.target.id,class:e.target.className},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'E'})}).catch(()=>{});})(event)" onclick="(function(e){e.stopPropagation();fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:dropdown:click',message:'Dropdown click',data:{target:e.target.tagName,id:e.target.id,class:e.target.className},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'E'})}).catch(()=>{});})(event)">
                                    <div class="p-2">
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:label:mousedown',message:'Label mousedown',data:{value:'all',target:e.target.tagName},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'C'})}).catch(()=>{});})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="all" onchange="updateStatusFilter()" checked onmousedown="(function(e){e.stopPropagation();fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:checkbox:mousedown',message:'Checkbox input mousedown',data:{value:'all'},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'C'})}).catch(()=>{});})(event)" onclick="(function(e){e.stopPropagation();fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:checkbox:inputClick',message:'Checkbox input clicked',data:{value:'all',checked:e.target.checked},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'C'})}).catch(()=>{});})(event)">
                                            <span class="text-white text-xs">ALL</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="IN STOCK" onchange="updateStatusFilter()" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">In Stock</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="BACK ORDER" onchange="updateStatusFilter()" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">Back Order</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="UNAVAILABLE" onchange="updateStatusFilter()" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">Unavailable</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="DOGGY" onchange="updateStatusFilter()" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">üêï Doggy</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="LOW STOCK" onchange="updateStatusFilter()" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">‚ö†Ô∏è Low Stock</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="PENDING" onchange="updateStatusFilter()" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">Pending</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <th class="p-6 w-32">
                            <div>SELLER</div>
                            <select id="sellerFilter" onchange="applyFilters()" class="filter-select">
                                <option value="all">ALL</option>
                                <option value="Amazon">Amazon</option>
                                <option value="3rd Party">3rd Party</option>
                            </select>
                        </th>

                        <th class="p-6 sortable-header" onclick="sortByPrice()" id="priceHeader">
                            Price
                            <span class="sort-indicator" id="priceSortIndicator">‚Üï</span>
                        </th>
                        <th class="p-6">Comment</th>
                        <th class="p-6">Snooze</th>
                        <th class="p-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100" id="tableBody">
                    <% reports.forEach((item, index) => { %>
                        <tr class="inventory-row transition-all <%= item.hasChanged ? 'bg-orange-200 border-l-8 border-orange-500' : 'hover:bg-slate-50' %> <%= item.isSnoozed ? 'opacity-60' : '' %> <%= item.availability === 'Doggy' ? 'border-l-4 border-purple-500' : '' %>"
                            data-asin="<%= item.asin %>"
                            data-price="<%= (item.price || 'N/A').replace(/"/g, '&quot;') %>">
                            <td class="p-6 text-center">
                                <input type="checkbox" class="asin-checkbox w-5 h-5 cursor-pointer" value="<%= item.asin %>" onchange="updateSelectAllState()">
                            </td>
                            <td class="p-6 text-base font-mono text-slate-500"><%= index + 1 %></td>
                            <td class="p-6 font-bold">
                                <% if(item.hasChanged) { %>
                                    <span class="px-2 py-1 rounded text-[10px] font-black bg-orange-600 text-white shadow-sm uppercase">UPDATED</span>
                                <% } else { %>
                                    <span class="px-2 py-1 rounded text-[10px] font-black bg-slate-200 text-slate-500 shadow-sm uppercase">STABLE</span>
                                <% } %>
                            </td>
                            <td class="p-6 asin-cell font-mono text-blue-600 font-bold text-base"><a href="https://www.amazon.ca/dp/<%= item.asin %>" target="_blank" class="hover:underline"><%= item.asin %></a></td>
                            <td class="p-6 title-cell text-slate-700 font-semibold text-base">
                                <div class="title-clamp <%= !item.hasReports ? 'text-slate-400 italic' : '' %>"><%= item.header %></div>
                                <% if(!item.hasReports) { %>
                                    <div class="mt-1 text-xs text-amber-600 font-bold bg-amber-100 border border-amber-300 rounded px-2 py-1 inline-block">
                                        ‚ö†Ô∏è No Report Yet
                                    </div>
                                <% } %>
                            </td>

                            <td class="p-6 text-center stock-cell font-black text-base"
                                data-availability-val="<%= (item.availability || '').toUpperCase() %>"
                                data-stocklevel-val="<%= (item.stock_level || '').toUpperCase() %>">

                                <% if(item.availability === 'In Stock') { %>
                                    <div class="text-emerald-600 uppercase">IN STOCK</div>
                                <% } else if(item.availability === 'Back Order') { %>
                                    <div class="text-amber-600 uppercase">BACK ORDER</div>
                                <% } else if(item.availability === 'Doggy') { %>
                                    <div class="text-purple-600 uppercase font-bold">
                                        <span class="text-xl">üêï</span> DOGGY
                                    </div>
                                    <div class="mt-1 text-[9px] text-purple-900 bg-purple-200 border border-purple-400 rounded px-1 py-0.5">
                                        Invalid Page
                                    </div>
                                <% } else if(item.availability === 'Pending') { %>
                                    <div class="text-slate-400 uppercase italic">PENDING</div>
                                <% } else { %>
                                    <div class="text-rose-600 uppercase">UNAVAILABLE</div>
                                <% } %>

                                <% if(item.stock_level && item.stock_level.includes('Low Stock')) { %>
                                    <div class="mt-1 text-[9px] text-amber-900 bg-amber-200 border border-amber-400 rounded px-1 py-0.5 animate-pulse">
                                        ‚ö†Ô∏è <%= item.stock_level.replace("Low Stock: ", "") %> left
                                    </div>
                                <% } %>
                            </td>

                            <td class="p-6 text-base font-black seller-cell <%= (item.seller && item.seller.includes('Amazon')) ? 'text-blue-600' : 'text-slate-500' %>" data-seller-val="<%= item.seller %>">
                                <%= item.seller %>
                            </td>

                            <td class="p-6 text-xl font-black text-slate-900 price-cell text-base"><%= item.price %></td>
                            <td class="p-6 text-base">
                                <div class="flex items-center gap-2">
                                    <span class="comment-text"><%= item.comment || '' %></span>
                                    <button data-asin="<%= item.asin %>" onclick="openCommentModalFromButton(this)" class="text-blue-600 hover:text-blue-800 text-sm font-bold">‚úèÔ∏è</button>
                                </div>
                            </td>
                            <td class="p-6 text-base">
                                <%
                                let snoozeOption = '';
                                if (item.snooze_until && item.isSnoozed) {
                                    const snoozeDate = new Date(item.snooze_until);
                                    const now = new Date();
                                    const diff = snoozeDate - now;
                                    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                                    if (days <= 1) snoozeOption = '1d';
                                    else if (days <= 7) snoozeOption = '1w';
                                    else if (days <= 30) snoozeOption = '1m';
                                    else snoozeOption = 'custom';
                                }
                                %>
                                <select onchange="setSnooze('<%= item.asin %>', this.value)" class="snooze-select border border-slate-300 rounded px-2 py-1 text-sm">
                                    <option value="" <%= snoozeOption === '' ? 'selected' : '' %>>No Snooze</option>
                                    <option value="1d" <%= snoozeOption === '1d' ? 'selected' : '' %>>1 Day</option>
                                    <option value="1w" <%= snoozeOption === '1w' ? 'selected' : '' %>>1 Week</option>
                                    <option value="1m" <%= snoozeOption === '1m' ? 'selected' : '' %>>1 Month</option>
                                    <option value="custom" <%= snoozeOption === 'custom' ? 'selected' : '' %>>Custom Date</option>
                                </select>
                                <% if(item.isSnoozed) { %>
                                    <div class="snooze-badge">
                                        Until <%= new Date(item.snooze_until).toLocaleDateString('en-US', { timeZone: 'America/Montreal', month: 'short', day: 'numeric' }) %>
                                    </div>
                                <% } %>
                            </td>
                            <td class="p-6 text-center text-base">
                                <div class="flex gap-2 justify-center">
                                    <% if(item.hasReports && item.history.length > 0) { %>
                                        <button onclick="toggleHistory('<%= item.asin %>')" class="px-4 py-2 bg-white text-slate-900 text-[10px] font-black rounded-lg border-2 border-slate-900 hover:bg-slate-900 hover:text-white transition-all history-toggle flex items-center gap-1" data-asin="<%= item.asin %>">
                                            <span>HISTORY</span>
                                            <span class="history-arrow transition-transform duration-200" id="arrow-<%= item.asin %>">‚ñº</span>
                                        </button>
                                    <% } else { %>
                                        <span class="px-4 py-2 bg-slate-200 text-slate-400 text-[10px] font-black rounded-lg border-2 border-slate-300 cursor-not-allowed">NO HISTORY</span>
                                    <% } %>
                                    <button onclick="removeAsin('<%= item.asin %>')" class="px-4 py-2 bg-rose-600 text-white text-[10px] font-black rounded-lg hover:bg-rose-700 transition-all">DELETE</button>
                                </div>
                            </td>
                        </tr>
                        <!-- History row (initially hidden) -->
                        <% if(item.hasReports && item.history.length > 0) { %>
                            <tr id="history-row-<%= item.asin %>" class="history-row hidden bg-slate-50">
                                <td colspan="11" class="p-6">
                                    <div class="bg-white rounded-lg border-2 border-slate-300 shadow-sm p-4">
                                        <h3 class="text-lg font-bold mb-4 text-slate-800">History for <span class="font-mono text-blue-600"><%= item.asin %></span> (<%= item.history.length %> entries)</h3>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-left text-sm">
                                                <thead class="bg-slate-800 text-white text-xs uppercase font-bold">
                                                    <tr>
                                                        <th class="p-3 border-b border-slate-700">Date</th>
                                                        <th class="p-3 border-b border-slate-700">Status</th>
                                                        <th class="p-3 border-b border-slate-700">Stock Level</th>
                                                        <th class="p-3 border-b border-slate-700">Seller</th>
                                                        <th class="p-3 border-b border-slate-700">Price</th>
                                                        <th class="p-3 border-b border-slate-700">Rank</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-200">
                                                    <% item.history.forEach(historyItem => { %>
                                                        <tr class="hover:bg-slate-50 transition-colors">
                                                            <td class="p-3 font-mono text-slate-500"><%= historyItem.check_date_formatted %></td>
                                                            <td class="p-3 font-bold <%= historyItem.isStockChange ? 'text-red-600' : 'text-slate-700' %>"><%= historyItem.availability %></td>
                                                            <td class="p-3 <%= historyItem.isStockChange ? 'text-red-600 font-bold' : 'text-slate-600' %>"><%= historyItem.stock_level %></td>
                                                            <td class="p-3 <%= historyItem.isSellerChange ? 'text-red-600 font-bold' : 'text-slate-600' %>"><%= historyItem.seller %></td>
                                                            <td class="p-3 font-mono <%= historyItem.isPriceChange ? 'bg-red-100 text-red-700 font-bold' : 'text-slate-800' %>"><%= historyItem.price %></td>
                                                            <td class="p-3 text-slate-500"><%= historyItem.ranking %></td>
                                                        </tr>
                                                    <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    <% }); %>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add ASIN Modal -->
    <div id="addAsinModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddAsinModal()">&times;</span>
            <div class="modal-header">Add New ASIN</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN (10 characters)</label>
                <input type="text" id="newAsinInput" placeholder="B08XYZ1234" maxlength="10" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
            </div>
            <div class="flex gap-3">
                <button id="addAsinButton" onclick="addAsin()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Add ASIN</button>
                <button onclick="closeAddAsinModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
            <div id="addAsinError" class="mt-3 text-sm font-bold hidden"></div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCommentModal()">&times;</span>
            <div class="modal-header">Edit Comment</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN: <span id="commentAsinDisplay" class="font-mono text-blue-600"></span></label>
                <textarea id="commentTextarea" rows="4" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter comment..."></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="saveComment()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Save</button>
                <button onclick="closeCommentModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Date Picker Modal -->
    <div id="datePickerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDatePickerModal()">&times;</span>
            <div class="modal-header">Set Snooze Date</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN: <span id="datePickerAsinDisplay" class="font-mono text-blue-600"></span></label>
                <label class="block text-sm font-bold mb-2">Snooze Until:</label>
                <input type="datetime-local" id="snoozeDateInput" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex gap-3">
                <button onclick="saveCustomSnooze()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Set Snooze</button>
                <button onclick="clearSnooze()" class="flex-1 bg-rose-600 text-white px-6 py-3 rounded-lg font-black hover:bg-rose-700 transition-all text-base">Clear Snooze</button>
                <button onclick="closeDatePickerModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const terminal = document.getElementById('terminal-stream');
        const container = document.getElementById('status-container');
        const syncStatus = document.getElementById('sync-status');
        const runBtn = document.getElementById('run-btn');
        const stopBtn = document.getElementById('stop-btn');
        const lastSyncTimeEl = document.getElementById('last-sync-time');

        let itemsProcessed = 0;
        let totalItems = 0;

        socket.on('scraper-log', (msg) => {
            if (container.classList.contains('hidden')) container.classList.remove('hidden');
            if (msg.includes('Processing')) {
                const match = msg.match(/\d+/);
                if (match) {
                    totalItems = parseInt(match[0]);
                    itemsProcessed = 0; // Reset counter for new report
                }
            }
            if (msg.includes('-->')) itemsProcessed++;
            if (totalItems > 0) syncStatus.innerText = `RUNNING: ${itemsProcessed} / ${totalItems}`;

            const line = document.createElement('div');
            line.className = "border-l-2 border-slate-700 pl-3 mb-1 py-0.5 font-mono text-[11px] leading-relaxed hover:bg-slate-800";
            if (msg.includes('In Stock')) line.classList.add('text-emerald-400');
            else if (msg.includes('Back Order')) line.classList.add('text-amber-400');
            else if (msg.includes('Unavailable')) line.classList.add('text-rose-400');
            else line.classList.add('text-slate-300');

            const montrealTime = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Montreal' });
            line.innerText = `[${montrealTime}] ${msg}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        });

        socket.on('scraper-done', (newTime) => {
            syncStatus.innerText = 'üèÅ COMPLETE';
            runBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            document.getElementById('run-selected-btn').disabled = false;
            updateRunSelectedButton(); // Update button text
            if(newTime) lastSyncTimeEl.innerText = newTime;

            const reloadPrompt = document.createElement('div');
            reloadPrompt.className = "mt-4 p-3 bg-blue-900/30 border border-blue-500 rounded text-blue-200 text-center font-bold animate-pulse cursor-pointer";
            reloadPrompt.innerText = "Scan Finished! Click to refresh.";
            reloadPrompt.onclick = () => window.location.reload();
            terminal.appendChild(reloadPrompt);
        });

        async function runReport() {
            itemsProcessed = 0;
            totalItems = 0;
            container.classList.remove('hidden');
            runBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            document.getElementById('run-selected-btn').disabled = true;
            terminal.innerHTML = '<div class="text-amber-400 font-bold mb-2">Connecting...</div>';
            await fetch('/run-report', { method: 'POST' });
        }

        async function stopReport() {
            if(confirm("Stop the scraper?")) {
                runBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                syncStatus.innerText = "STOPPING...";
                await fetch('/stop-report', { method: 'POST' });
            }
        }

        // Price sorting state
        let priceSortState = 'none'; // 'none', 'asc', 'desc'
        let currentAsinForComment = null;
        let currentAsinForSnooze = null;

        // Selection management
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.asin-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateRunSelectedButton();
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.asin-checkbox');
            const selectAll = document.getElementById('selectAll');
            const checkedCount = document.querySelectorAll('.asin-checkbox:checked').length;
            selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
            updateRunSelectedButton();
        }

        function updateRunSelectedButton() {
            const checkedCount = document.querySelectorAll('.asin-checkbox:checked').length;
            const runSelectedBtn = document.getElementById('run-selected-btn');
            if (checkedCount > 0) {
                runSelectedBtn.disabled = false;
                runSelectedBtn.textContent = `RUN ON SELECTED (${checkedCount})`;
            } else {
                runSelectedBtn.disabled = true;
                runSelectedBtn.textContent = 'RUN ON SELECTED';
            }
        }

        async function runReportOnSelected() {
            const checkedBoxes = document.querySelectorAll('.asin-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one ASIN');
                return;
            }

            const asins = Array.from(checkedBoxes).map(cb => cb.value);

            if (!confirm(`Run report on ${asins.length} selected ASIN${asins.length > 1 ? 's' : ''}?`)) {
                return;
            }

            const runSelectedBtn = document.getElementById('run-selected-btn');
            const runBtn = document.getElementById('run-btn');
            const stopBtn = document.getElementById('stop-btn');
            const container = document.getElementById('status-container');
            const terminal = document.getElementById('terminal-stream');
            const syncStatus = document.getElementById('sync-status');

            try {
                runSelectedBtn.disabled = true;
                runBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                container.classList.remove('hidden');
                syncStatus.innerText = `RUNNING: 0 / ${asins.length}`;
                terminal.innerHTML = '<div class="text-amber-400 font-bold mb-2">Starting report on selected ASINs...</div>';

                const response = await fetch('/run-report-selected', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asins })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start report');
                }
            } catch (err) {
                alert('Error: ' + err.message);
                runSelectedBtn.disabled = false;
                runBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            }
        }

        // ASIN Management
        function openAddAsinModal() {
            document.getElementById('addAsinModal').style.display = 'block';
            document.getElementById('newAsinInput').value = '';
            document.getElementById('addAsinError').classList.add('hidden');
            document.getElementById('newAsinInput').focus();
        }

        function closeAddAsinModal() {
            document.getElementById('addAsinModal').style.display = 'none';
        }

        async function addAsin() {
            const asin = document.getElementById('newAsinInput').value.trim().toUpperCase();
            const errorDiv = document.getElementById('addAsinError');
            const addButton = document.getElementById('addAsinButton');
            const originalText = addButton.textContent;

            if (!asin || asin.length !== 10) {
                errorDiv.textContent = 'ASIN must be exactly 10 characters';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Show loading state
            addButton.disabled = true;
            addButton.textContent = 'Adding...';
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/asins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asin })
                });

                const data = await response.json();
                if (response.ok) {
                    closeAddAsinModal();
                    // Immediately reload to show new ASIN
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Failed to add ASIN';
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.remove('text-green-600');
                    errorDiv.classList.add('text-red-600');
                    addButton.disabled = false;
                    addButton.textContent = originalText;
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
                errorDiv.classList.remove('text-green-600');
                errorDiv.classList.add('text-red-600');
                addButton.disabled = false;
                addButton.textContent = originalText;
            }
        }

        async function removeAsin(asin) {
            if (!confirm(`Are you sure you want to remove ASIN ${asin}?`)) return;

            try {
                const response = await fetch(`/api/asins/${asin}`, { method: 'DELETE' });
                if (response.ok) {
                    // Immediately reload to show removal
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to remove ASIN'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Comment Management
        function openCommentModalFromButton(button) {
            const asin = button.dataset.asin;
            const commentText = button.previousElementSibling.textContent;
            openCommentModal(asin, commentText);
        }

        function openCommentModal(asin, currentComment) {
            currentAsinForComment = asin;
            document.getElementById('commentAsinDisplay').textContent = asin;
            document.getElementById('commentTextarea').value = currentComment || '';
            document.getElementById('commentModal').style.display = 'block';
            document.getElementById('commentTextarea').focus();
        }

        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            currentAsinForComment = null;
        }

        async function saveComment() {
            if (!currentAsinForComment) return;

            const comment = document.getElementById('commentTextarea').value.trim();

            try {
                const response = await fetch(`/api/asins/${currentAsinForComment}/comment`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment })
                });

                if (response.ok) {
                    closeCommentModal();
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to save comment'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Snooze Management
        function setSnooze(asin, option) {
            currentAsinForSnooze = asin;

            if (option === 'custom') {
                document.getElementById('datePickerAsinDisplay').textContent = asin;
                document.getElementById('datePickerModal').style.display = 'block';
                // Set default to tomorrow in local time
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                // Format as YYYY-MM-DDTHH:mm for datetime-local (local time)
                const year = tomorrow.getFullYear();
                const month = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const day = String(tomorrow.getDate()).padStart(2, '0');
                const hours = String(tomorrow.getHours()).padStart(2, '0');
                const minutes = String(tomorrow.getMinutes()).padStart(2, '0');
                document.getElementById('snoozeDateInput').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else if (option === '') {
                clearSnooze();
            } else {
                let date = new Date();
                if (option === '1d') date.setDate(date.getDate() + 1);
                else if (option === '1w') date.setDate(date.getDate() + 7);
                else if (option === '1m') date.setMonth(date.getMonth() + 1);

                saveSnooze(asin, date.toISOString());
            }
        }

        function closeDatePickerModal() {
            document.getElementById('datePickerModal').style.display = 'none';
            currentAsinForSnooze = null;
        }

        async function saveCustomSnooze() {
            if (!currentAsinForSnooze) return;

            const dateValue = document.getElementById('snoozeDateInput').value;
            if (!dateValue) {
                alert('Please select a date');
                return;
            }

            // datetime-local gives local time, convert to ISO string for storage
            // Create date from local time string (browser interprets as local)
            const localDate = new Date(dateValue);
            // Convert to ISO string for storage (server expects UTC)
            await saveSnooze(currentAsinForSnooze, localDate.toISOString());
        }

        async function clearSnooze() {
            if (!currentAsinForSnooze) return;

            await saveSnooze(currentAsinForSnooze, null);
        }

        async function saveSnooze(asin, snoozeUntil) {
            try {
                const response = await fetch(`/api/asins/${asin}/snooze`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snooze_until: snoozeUntil })
                });

                if (response.ok) {
                    closeDatePickerModal();
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to set snooze'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Price Sorting
        function sortByPrice() {
            const rows = Array.from(document.querySelectorAll('.inventory-row'));
            const indicator = document.getElementById('priceSortIndicator');

            // Toggle sort state
            if (priceSortState === 'none') priceSortState = 'asc';
            else if (priceSortState === 'asc') priceSortState = 'desc';
            else priceSortState = 'none';

            // Update indicator
            if (priceSortState === 'asc') indicator.textContent = '‚Üë';
            else if (priceSortState === 'desc') indicator.textContent = '‚Üì';
            else indicator.textContent = '‚Üï';

            if (priceSortState === 'none') {
                // Reload page to get default sort
                window.location.reload();
                return;
            }

            // Separate snoozed and non-snoozed items
            const snoozed = rows.filter(r => r.classList.contains('opacity-60'));
            const notSnoozed = rows.filter(r => !r.classList.contains('opacity-60'));

            // Sort non-snoozed items by price
            notSnoozed.sort((a, b) => {
                const priceA = parsePrice(a.getAttribute('data-price'));
                const priceB = parsePrice(b.getAttribute('data-price'));
                return priceSortState === 'asc' ? priceA - priceB : priceB - priceA;
            });

            // Reorder: non-snoozed (sorted) first, then snoozed
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            notSnoozed.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = index + 1;
                tbody.appendChild(row);
            });
            snoozed.forEach((row, index) => {
                row.querySelector('td:first-child').textContent = notSnoozed.length + index + 1;
                tbody.appendChild(row);
            });
        }

        function parsePrice(priceStr) {
            if (!priceStr || priceStr === 'N/A') return 0;
            // Remove currency symbols and extract number
            const match = priceStr.match(/[\d,]+\.?\d*/);
            if (!match) return 0;
            return parseFloat(match[0].replace(/,/g, ''));
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addAsinModal');
            const commentModal = document.getElementById('commentModal');
            const dateModal = document.getElementById('datePickerModal');
            if (event.target === addModal) closeAddAsinModal();
            if (event.target === commentModal) closeCommentModal();
            if (event.target === dateModal) closeDatePickerModal();
        }

        // Multi-select status filter
        let selectedStatuses = ['all'];

        function toggleStatusDropdown(event) {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:toggleStatusDropdown:entry',message:'toggleStatusDropdown called',data:{eventPresent:!!event},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('statusDropdown');
            if (!dropdown) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:toggleStatusDropdown:noElement',message:'Dropdown element not found',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                // #endregion
                return;
            }

            const isHidden = dropdown.classList.contains('hidden');
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:toggleStatusDropdown:beforeToggle',message:'Dropdown state before toggle',data:{isHidden,hasHiddenClass:dropdown.classList.contains('hidden'),displayStyle:window.getComputedStyle(dropdown).display,zIndex:window.getComputedStyle(dropdown).zIndex},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion

            // Close all other dropdowns first
            document.querySelectorAll('[id^="statusDropdown"]').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.add('hidden');
                }
            });

            if (isHidden) {
                dropdown.classList.remove('hidden');
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:toggleStatusDropdown:afterShow',message:'Dropdown shown',data:{hasHiddenClass:dropdown.classList.contains('hidden'),displayStyle:window.getComputedStyle(dropdown).display},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
                // #endregion
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function updateStatusFilter() {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:updateStatusFilter:entry',message:'updateStatusFilter called',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
            // #endregion
            const checkboxes = document.querySelectorAll('.status-checkbox');
            const allCheckbox = document.querySelector('.status-checkbox[value="all"]');
            const otherCheckboxes = Array.from(checkboxes).filter(cb => cb.value !== 'all');
            // #region agent log
            const checkboxStates = Array.from(checkboxes).map(cb => ({value:cb.value,checked:cb.checked}));
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:updateStatusFilter:checkboxesFound',message:'Checkboxes found',data:{totalCheckboxes:checkboxes.length,otherCheckboxes:otherCheckboxes.length,allCheckboxFound:!!allCheckbox,allChecked:allCheckbox?.checked,checkboxStates},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'C'})}).catch(()=>{});
            // #endregion

            selectedStatuses = [];

            // If "all" is checked, uncheck others and select all
            if (allCheckbox && allCheckbox.checked) {
                otherCheckboxes.forEach(cb => cb.checked = false);
                selectedStatuses = ['all'];
                const statusText = document.getElementById('statusFilterText');
                if (statusText) statusText.textContent = 'ALL';
            } else {
                // Uncheck "all" if other checkboxes are selected
                if (allCheckbox) allCheckbox.checked = false;

                // Get selected statuses
                otherCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedStatuses.push(cb.value);
                    }
                });

                // If nothing is selected, default to "all"
                if (selectedStatuses.length === 0) {
                    if (allCheckbox) allCheckbox.checked = true;
                    selectedStatuses = ['all'];
                    const statusText = document.getElementById('statusFilterText');
                    if (statusText) statusText.textContent = 'ALL';
                } else {
                    const count = selectedStatuses.length;
                    const statusText = document.getElementById('statusFilterText');
                    if (statusText) {
                        statusText.textContent = count === 1 ? selectedStatuses[0].replace(/_/g, ' ') : `${count} Selected`;
                    }
                }
            }

            // #region agent log
            const finalStates = Array.from(checkboxes).map(cb => ({value:cb.value,checked:cb.checked}));
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:updateStatusFilter:afterUpdate',message:'After update',data:{selectedStatuses,allChecked:allCheckbox?.checked,finalStates},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'C'})}).catch(()=>{});
            // #endregion

            applyFilters();
        }

        // Close dropdown when clicking outside - use capture phase to check before event propagates
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('statusDropdown');
            const button = document.getElementById('statusFilterBtn');
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:clickOutside:entry',message:'Click outside handler fired',data:{dropdownFound:!!dropdown,buttonFound:!!button,targetId:event.target?.id,targetClass:event.target?.className,targetTag:event.target?.tagName,dropdownContains:dropdown?.contains(event.target),buttonContains:button?.contains(event.target),isCheckbox:event.target?.type==='checkbox',isLabel:event.target?.tagName==='LABEL'},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'D'})}).catch(()=>{});
            // #endregion
            if (dropdown && button) {
                // Check if click is on a checkbox or label inside dropdown
                const isInsideDropdown = dropdown.contains(event.target);
                const isOnButton = button.contains(event.target);
                const isCheckbox = event.target.type === 'checkbox';
                const isLabel = event.target.tagName === 'LABEL';
                const isInDropdownContent = isCheckbox || isLabel;

                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:clickOutside:check',message:'Click outside check',data:{isInsideDropdown,isOnButton,isCheckbox,isLabel,isInDropdownContent,shouldClose:!isInsideDropdown && !isOnButton},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'D'})}).catch(()=>{});
                // #endregion

                if (!isInsideDropdown && !isOnButton) {
                    // #region agent log
                    fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'index.ejs:clickOutside:closing',message:'Closing dropdown due to outside click',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run2',hypothesisId:'D'})}).catch(()=>{});
                    // #endregion
                    dropdown.classList.add('hidden');
                }
            }
        }, true); // Use capture phase

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const seller = document.getElementById('sellerFilter').value;

            const rows = document.querySelectorAll('.inventory-row');

            rows.forEach(row => {
                const title = row.querySelector('.title-cell').innerText.toLowerCase();
                const asin = row.querySelector('.asin-cell').innerText.toLowerCase();
                const stockVal = row.querySelector('.stock-cell').getAttribute('data-availability-val') || "";
                const stockLevelVal = row.querySelector('.stock-cell').getAttribute('data-stocklevel-val') || "";
                const sellerVal = row.querySelector('.seller-cell').getAttribute('data-seller-val') || "";

                const matchSearch = title.includes(search) || asin.includes(search);

                // Multi-select status matching
                let matchStock = true;
                if (!selectedStatuses.includes('all')) {
                    matchStock = false;
                    for (const status of selectedStatuses) {
                        if (status === 'LOW STOCK' && stockLevelVal.includes('LOW STOCK')) {
                            matchStock = true;
                            break;
                        } else if (status === 'DOGGY' && stockVal === 'DOGGY') {
                            matchStock = true;
                            break;
                        } else if (status === 'PENDING' && stockVal === 'PENDING') {
                            matchStock = true;
                            break;
                        } else if (stockVal === status.toUpperCase()) {
                            matchStock = true;
                            break;
                        }
                    }
                }

                let matchSeller = true;
                if (seller === 'Amazon') matchSeller = sellerVal.includes('Amazon');
                if (seller === '3rd Party') matchSeller = sellerVal.includes('3rd Party');

                if (matchSearch && matchStock && matchSeller) {
                    row.classList.remove('hidden-row');
                    // Also show/hide history rows if they exist
                    const asinValue = row.getAttribute('data-asin');
                    if (asinValue) {
                        const historyRow = document.getElementById(`history-row-${asinValue}`);
                        if (historyRow && !historyRow.classList.contains('hidden')) {
                            historyRow.classList.remove('hidden-row');
                        }
                    }
                } else {
                    row.classList.add('hidden-row');
                    // Hide history rows when parent is hidden
                    const asinValue = row.getAttribute('data-asin');
                    if (asinValue) {
                        const historyRow = document.getElementById(`history-row-${asinValue}`);
                        if (historyRow) {
                            historyRow.classList.add('hidden-row');
                        }
                    }
                }
            });
        }

        // History toggle function
        function toggleHistory(asin) {
            const historyRow = document.getElementById(`history-row-${asin}`);
            const toggleBtn = document.querySelector(`.history-toggle[data-asin="${asin}"]`);
            const arrow = document.getElementById(`arrow-${asin}`);

            if (historyRow) {
                const isHidden = historyRow.classList.contains('hidden');

                if (isHidden) {
                    // Show history
                    historyRow.classList.remove('hidden');
                    const historyText = toggleBtn.querySelector('span:first-child');
                    if (historyText) historyText.textContent = 'HIDE HISTORY';
                    toggleBtn.classList.remove('bg-white', 'text-slate-900');
                    toggleBtn.classList.add('bg-slate-900', 'text-white');
                    if (arrow) {
                        arrow.textContent = '‚ñ≤';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                } else {
                    // Hide history
                    historyRow.classList.add('hidden');
                    const historyText = toggleBtn.querySelector('span:first-child');
                    if (historyText) historyText.textContent = 'HISTORY';
                    toggleBtn.classList.remove('bg-slate-900', 'text-white');
                    toggleBtn.classList.add('bg-white', 'text-slate-900');
                    if (arrow) {
                        arrow.textContent = '‚ñº';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectAllState();
        });
    </script>
</body>
</html>
