<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Amazon Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; font-size: 16px; }
        .hidden-row { display: none !important; }
        .terminal-scrollbar::-webkit-scrollbar { width: 4px; }
        .terminal-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .title-clamp { display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        select.filter-select {
            background-color: #1e293b;
            color: white;
            font-size: 0.65rem;
            border: 1px solid #475569;
            border-radius: 4px;
            padding: 4px;
            margin-top: 4px;
            width: 100%;
            cursor: pointer;
            outline: none;
        }
        select.filter-select:hover { border-color: #94a3b8; }

        /* Table header - not sticky to avoid z-index conflicts */
        #inventoryTable thead {
            background: #0f172a;
        }

        /* Ensure main header is always visible */
        #mainHeader {
            position: sticky !important;
            top: 0 !important;
            z-index: 100 !important;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Sortable price header */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sortable-header:hover {
            background-color: #1e293b;
        }
        .sort-indicator {
            display: inline-block;
            margin-left: 4px;
            font-size: 0.7rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        /* Excel upload modal - larger */
        #excelUploadModal .modal-content {
            max-width: 900px;
            padding: 40px;
        }
        .modal-header {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 20px;
            color: #0f172a;
        }
        .modal-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-close:hover {
            color: #000;
        }

        /* Snooze badge */
        .snooze-badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: #fbbf24;
            color: #78350f;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-top: 4px;
        }

        /* Enhanced datetime-local input styling */
        #snoozeDateInput {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border: 2px solid #cbd5e1;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #snoozeDateInput:hover {
            border-color: #94a3b8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #snoozeDateInput:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            outline: none;
        }

        /* Date picker wrapper with clock icon */
        .date-picker-wrapper {
            position: relative;
        }

        .date-picker-wrapper::before {
            content: "üïê";
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            pointer-events: none;
            z-index: 1;
        }

        /* Prevent infinite scrolling in datetime-local */
        #snoozeDateInput::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        #snoozeDateInput::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* Excel Upload Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            padding-bottom: 25px;
            border-bottom: 3px solid #e2e8f0;
            position: relative;
        }
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
            transition: all 0.3s ease;
        }
        .step.active {
            color: #3b82f6;
            font-weight: 900;
            transform: scale(1.05);
        }
        .step.completed {
            color: #10b981;
        }
        .step-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            line-height: 40px;
            margin-bottom: 8px;
            font-weight: 900;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step.active .step-number {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transform: scale(1.1);
        }
        .step.completed .step-number {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: 60%;
            width: 80%;
            height: 3px;
            background: #e2e8f0;
            z-index: -1;
        }
        .step.completed:not(:last-child)::after {
            background: linear-gradient(90deg, #10b981 0%, #e2e8f0 100%);
        }
        .upload-step {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-step.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8">
    <div class="max-w-full mx-auto">

        <div id="status-container" class="hidden mb-6 bg-slate-900 text-emerald-400 p-5 rounded-2xl border-l-8 border-emerald-500 font-mono text-xs shadow-2xl">
            <div class="flex justify-between items-center border-b border-emerald-900 pb-2 mb-2">
                <span class="font-black uppercase tracking-widest">Live Scraper Feed</span>
                <span id="sync-status" class="text-white font-bold bg-emerald-800 px-2 rounded">IDLE</span>
            </div>
            <div id="terminal-stream" class="h-40 overflow-y-auto terminal-scrollbar leading-relaxed"></div>
        </div>

        <header id="mainHeader" class="sticky top-0 z-[100] bg-slate-100 pt-4 pb-4 -mx-4 md:-mx-8 px-4 md:px-8 flex flex-col lg:flex-row justify-between items-end mb-8 gap-6 shadow-lg" style="position: sticky !important; top: 0 !important; z-index: 100 !important;">
            <div>
                <h1 class="text-4xl font-black text-slate-900 tracking-tight text-emerald-600">Inventory Dashboard</h1>
                <p class="text-slate-500 font-bold italic">Montreal / Outremont (H2V)</p>
            </div>
            <div class="flex flex-wrap gap-2 md:gap-4 items-end">
                <div class="flex flex-col w-full sm:w-auto">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Search</label>
                    <input type="text" id="searchInput" onkeyup="applyFilters()" placeholder="ASIN or Title..." class="px-3 md:px-5 py-2 md:py-3 rounded-xl border-2 border-slate-200 w-full sm:w-64 outline-none focus:ring-2 focus:ring-blue-500 text-sm md:text-base">
                </div>

                <div class="flex flex-col w-full sm:w-auto relative">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Date Range Filter</label>
                    <button onclick="toggleDateRangePicker()" id="dateRangeBtn" class="px-3 md:px-5 py-2 md:py-3 rounded-xl border-2 border-slate-200 outline-none focus:ring-2 focus:ring-orange-500 text-sm md:text-base bg-white text-left flex items-center gap-2 min-w-[200px]">
                        <span id="dateRangeLabel">All Updates</span>
                        <svg class="w-4 h-4 ml-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    </button>

                    <!-- Date Range Picker Dropdown -->
                    <div id="dateRangePicker" class="hidden fixed bg-white rounded-2xl shadow-2xl border border-slate-200 p-4 z-[99999] min-w-[340px]">
                        <!-- Quick Presets -->
                        <div class="flex flex-wrap gap-2 mb-4">
                            <button onclick="setDatePreset('all')" class="preset-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 hover:bg-orange-100 hover:text-orange-700 transition-all" data-preset="all">All</button>
                            <button onclick="setDatePreset('24h')" class="preset-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 hover:bg-orange-100 hover:text-orange-700 transition-all" data-preset="24h">24h</button>
                            <button onclick="setDatePreset('48h')" class="preset-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 hover:bg-orange-100 hover:text-orange-700 transition-all" data-preset="48h">48h</button>
                            <button onclick="setDatePreset('7d')" class="preset-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 hover:bg-orange-100 hover:text-orange-700 transition-all" data-preset="7d">7 Days</button>
                            <button onclick="setDatePreset('30d')" class="preset-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 hover:bg-orange-100 hover:text-orange-700 transition-all" data-preset="30d">30 Days</button>
                            <button onclick="showCustomCalendar(event)" class="preset-btn px-3 py-1 rounded-lg text-xs font-bold bg-slate-100 hover:bg-orange-100 hover:text-orange-700 transition-all" data-preset="custom">Custom Range</button>
                        </div>

                        <!-- Calendar Section (hidden by default) -->
                        <div id="calendarSection" class="hidden">
                            <!-- Calendar Header -->
                            <div class="flex items-center justify-between mb-2">
                                <button onclick="changeCalendarMonth(-1); event.stopPropagation();" class="p-1 hover:bg-slate-100 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                                <span id="calendarMonthYear" class="font-bold text-slate-700"></span>
                                <button onclick="changeCalendarMonth(1); event.stopPropagation();" class="p-1 hover:bg-slate-100 rounded-lg"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></button>
                            </div>

                            <!-- Calendar Grid -->
                            <div class="grid grid-cols-7 gap-1 text-center text-xs mb-2">
                                <div class="font-bold text-slate-400 py-1">Su</div>
                                <div class="font-bold text-slate-400 py-1">Mo</div>
                                <div class="font-bold text-slate-400 py-1">Tu</div>
                                <div class="font-bold text-slate-400 py-1">We</div>
                                <div class="font-bold text-slate-400 py-1">Th</div>
                                <div class="font-bold text-slate-400 py-1">Fr</div>
                                <div class="font-bold text-slate-400 py-1">Sa</div>
                            </div>
                            <div id="calendarDays" class="grid grid-cols-7 gap-1 text-center text-sm"></div>

                            <!-- Selected Range Display -->
                            <div id="selectedRangeDisplay" class="mt-3 pt-3 border-t border-slate-200 text-xs text-slate-600 text-center">
                                Click to select start date, then end date
                            </div>

                            <!-- Apply/Clear Buttons -->
                            <div class="flex gap-2 mt-3">
                                <button onclick="clearDateRange(); event.stopPropagation();" class="flex-1 px-3 py-2 bg-slate-100 text-slate-700 font-bold rounded-lg hover:bg-slate-200 transition-all text-sm">Clear</button>
                                <button onclick="applyDateRangeAndClose(); event.stopPropagation();" class="flex-1 px-3 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition-all text-sm">Apply Filter</button>
                            </div>
                        </div>
                    </div>
                </div>

                <a href="/products" class="bg-slate-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-slate-700 active:scale-95 transition-all text-sm md:text-base">üì¶ PRODUCTS</a>

                <a href="/api-explorer" class="bg-amber-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-amber-700 active:scale-95 transition-all text-sm md:text-base">üîå API EXPLORER</a>

                <a href="/vendor-analytics" class="bg-blue-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-blue-800 active:scale-95 transition-all text-sm md:text-base">VENDOR ANALYTICS</a>

                <a href="/purchase-orders" class="bg-purple-700 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-purple-800 active:scale-95 transition-all text-sm md:text-base">PURCHASE ORDERS</a>

                <button onclick="openAddAsinModal()" class="bg-green-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-green-700 active:scale-95 transition-all text-sm md:text-base">+ ADD ASIN</button>

                <button onclick="openExcelUploadModal()" class="bg-indigo-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-indigo-700 active:scale-95 transition-all text-sm md:text-base">üìä UPLOAD EXCEL</button>

                <button onclick="CSVExport.openColumnSelector('dashboard')" class="bg-emerald-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-emerald-700 active:scale-95 transition-all text-sm md:text-base flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    CSV
                </button>

                <button onclick="runReportOnSelected()" id="run-selected-btn" class="bg-purple-600 text-white px-4 md:px-6 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-purple-700 active:scale-95 transition-all text-sm md:text-base disabled:opacity-50 disabled:cursor-not-allowed" disabled>RUN ON SELECTED</button>

                <button onclick="runReport()" id="run-btn" class="bg-blue-600 text-white px-4 md:px-8 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-blue-700 active:scale-95 transition-all text-sm md:text-base">RUN ALL</button>
                <button onclick="stopReport()" id="stop-btn" class="hidden bg-rose-600 text-white px-4 md:px-8 py-2 md:py-3 rounded-xl font-black shadow-lg hover:bg-rose-700 active:scale-95 transition-all animate-pulse text-sm md:text-base">STOP</button>

                <div class="bg-white px-4 md:px-6 py-2 md:py-2.5 rounded-xl border border-slate-200 shadow-sm min-w-[140px] md:min-w-[160px]">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Last Report End</p>
                    <p id="last-sync-time" class="text-lg md:text-xl font-mono font-black text-blue-600"><%= lastSyncTime %></p>
                </div>
                <% if (typeof globalLastOrderDate !== 'undefined' && globalLastOrderDate) { %>
                <div class="bg-purple-50 px-4 md:px-6 py-2 md:py-2.5 rounded-xl border border-purple-200 shadow-sm min-w-[140px] md:min-w-[160px]">
                    <p class="text-[10px] font-black text-purple-400 uppercase tracking-widest">Last PO Date</p>
                    <p class="text-lg md:text-xl font-mono font-black text-purple-600"><%= new Date(globalLastOrderDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %></p>
                </div>
                <% } %>
            </div>
        </header>

        <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200" id="tableWrapper">
            <div class="overflow-x-auto min-h-[400px]" id="tableContainer">
                <table class="w-full min-w-full text-left border-collapse" id="inventoryTable">
                <thead>
                    <tr class="bg-slate-900 text-white text-[10px] font-black uppercase tracking-widest">
                        <th class="p-6">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-5 h-5 cursor-pointer">
                        </th>
                        <th class="p-6">#</th>
                        <th class="p-6">Status</th>
                        <th class="p-6 cursor-pointer hover:bg-slate-800" onclick="sortColumn('asin')">
                            <div class="flex items-center gap-1">
                                ASIN
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'asin') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                        </th>
                        <th class="p-6 w-1/3">Product</th>

                        <th class="p-6 text-center w-48">
                            <div class="cursor-pointer hover:bg-slate-800 inline-block px-2 py-1 rounded" onclick="sortColumn('availability')">
                                <span>STOCK STATUS</span>
                                <span class="text-xs ml-1"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'availability') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                            <div class="relative inline-block w-full">
                                <button onclick="toggleStatusDropdown(event)" id="statusFilterBtn" class="filter-select w-full text-left px-3 py-2 flex items-center justify-between">
                                    <span id="statusFilterText"><%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.length > 0 && !currentFilters.filterStatus.includes('all')) ? currentFilters.filterStatus.join(', ') : 'ALL' %></span>
                                    <span class="ml-auto">‚ñº</span>
                                </button>
                                <div id="statusDropdown" class="hidden absolute z-[200] w-full min-w-[200px] mt-1 bg-slate-800 border border-slate-700 rounded shadow-lg max-h-64 overflow-y-auto" style="top: 100%; left: 0; right: auto;" onmousedown="(function(e){e.stopPropagation();})(event)" onclick="(function(e){e.stopPropagation();})(event)">
                                    <div class="p-2">
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="all" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters === 'undefined' || currentFilters.filterStatus.length === 0 || currentFilters.filterStatus.includes('all')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">ALL</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="IN STOCK" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.includes('IN STOCK')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">In Stock</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="BACK ORDER" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.includes('BACK ORDER')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">Back Order</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="UNAVAILABLE" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.includes('UNAVAILABLE')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">Unavailable</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="DOGGY" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.includes('DOGGY')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">üêï Doggy</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="LOW STOCK" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.includes('LOW STOCK')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">‚ö†Ô∏è Low Stock</span>
                                        </label>
                                        <label class="flex items-center p-2 hover:bg-slate-700 cursor-pointer" onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <input type="checkbox" class="status-checkbox mr-2 w-4 h-4" value="PENDING" onchange="updateStatusFilterServer(event)" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterStatus.includes('PENDING')) ? 'checked' : '' %> onmousedown="(function(e){e.stopPropagation();})(event)">
                                            <span class="text-white text-xs">Pending</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </th>

                        <th class="p-6 w-32 cursor-pointer hover:bg-slate-800" onclick="sortColumn('seller')">
                            <div class="flex items-center gap-1">
                                SELLER
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'seller') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                            <select id="sellerFilter" onchange="applySellerFilterServer()" class="filter-select" onclick="event.stopPropagation()">
                                <option value="all" <%= (typeof currentFilters === 'undefined' || currentFilters.filterSeller === 'all') ? 'selected' : '' %>>ALL</option>
                                <option value="Amazon" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterSeller === 'Amazon') ? 'selected' : '' %>>Amazon</option>
                                <option value="3rd Party" <%= (typeof currentFilters !== 'undefined' && currentFilters.filterSeller === '3rd Party') ? 'selected' : '' %>>3rd Party</option>
                            </select>
                        </th>

                        <th class="p-6 cursor-pointer hover:bg-slate-800" onclick="sortColumn('price')">
                            <div class="flex items-center gap-1">
                                Price
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'price') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                        </th>
                        <th class="p-6 text-center cursor-pointer hover:bg-slate-800" onclick="sortColumn('sales')">
                            <div class="flex items-center justify-center gap-1">
                                <div>
                                    <div>Sales</div>
                                    <div class="text-[8px] text-slate-400 font-normal normal-case">Vendor Reports</div>
                                </div>
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'sales') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                        </th>
                        <th class="p-6 text-center cursor-pointer hover:bg-slate-800" onclick="sortColumn('traffic')">
                            <div class="flex items-center justify-center gap-1">
                                <div>
                                    <div>Traffic</div>
                                    <div class="text-[8px] text-slate-400 font-normal normal-case">Glance Views</div>
                                </div>
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'traffic') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                        </th>
                        <th class="p-6 text-center cursor-pointer hover:bg-slate-800" onclick="sortColumn('received')">
                            <div class="flex items-center justify-center gap-1">
                                <div>
                                    <div>Received</div>
                                    <div class="text-[8px] text-slate-400 font-normal normal-case">PO Receiving</div>
                                </div>
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'received') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                        </th>
                        <th class="p-6 cursor-pointer hover:bg-slate-800" onclick="sortColumn('lastPO')">
                            <div class="flex items-center gap-1">
                                Last PO
                                <span class="text-xs"><%= (typeof currentSort !== 'undefined' && currentSort.sortBy === 'lastPO') ? (currentSort.sortDir === 'asc' ? '‚ñ≤' : '‚ñº') : '‚Üï' %></span>
                            </div>
                        </th>
                        <th class="p-6">Comment</th>
                        <th class="p-6">Snooze</th>
                        <th class="p-6 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100" id="tableBody">
                    <% reports.forEach((item, index) => { %>
                        <tr class="inventory-row transition-all <%= item.hasChanged ? 'bg-orange-200 border-l-8 border-orange-500' : 'hover:bg-slate-50' %> <%= item.isSnoozed ? 'opacity-60' : '' %> <%= item.availability === 'Doggy' ? 'border-l-4 border-purple-500' : '' %>"
                            data-asin="<%= item.asin %>"
                            data-price="<%= (item.price || 'N/A').replace(/"/g, '&quot;') %>"
                            data-check-date="<%= item.check_date ? new Date(item.check_date).toISOString() : '' %>"
                            data-has-changed="<%= item.hasChanged ? 'true' : 'false' %>">
                            <td class="p-6 text-center">
                                <input type="checkbox" class="asin-checkbox w-5 h-5 cursor-pointer" value="<%= item.asin %>" onchange="updateSelectAllState()">
                            </td>
                            <td class="p-6 text-base font-mono text-slate-500"><%= index + 1 %></td>
                            <td class="p-6 font-bold">
                                <% if(item.hasChanged) { %>
                                    <span class="px-2 py-1 rounded text-[10px] font-black bg-orange-600 text-white shadow-sm uppercase">UPDATED</span>
                                <% } else { %>
                                    <span class="px-2 py-1 rounded text-[10px] font-black bg-slate-200 text-slate-500 shadow-sm uppercase">STABLE</span>
                                <% } %>
                            </td>
                            <td class="p-6 asin-cell font-mono text-blue-600 font-bold text-base"><a href="https://www.amazon.ca/dp/<%= item.asin %>" target="_blank" class="hover:underline"><%= item.asin %></a></td>
                            <td class="p-6 title-cell text-slate-700 font-semibold text-base">
                                <div class="title-clamp <%= !item.hasReports ? 'text-slate-400 italic' : '' %>"><%= item.header %></div>
                                <% if(!item.hasReports) { %>
                                    <div class="mt-1 text-xs text-amber-600 font-bold bg-amber-100 border border-amber-300 rounded px-2 py-1 inline-block">
                                        ‚ö†Ô∏è No Report Yet
                                    </div>
                                <% } %>
                            </td>

                            <td class="p-6 text-center stock-cell font-black text-base <%= (item.changedFields && (item.changedFields.includes('availability') || item.changedFields.includes('stock'))) ? 'bg-amber-50' : '' %>"
                                data-availability-val="<%= (item.availability || '').toUpperCase() %>"
                                data-stocklevel-val="<%= (item.stock_level || '').toUpperCase() %>">

                                <% const stockChanged = item.changedFields && (item.changedFields.includes('availability') || item.changedFields.includes('stock')); %>
                                <% if(item.availability === 'In Stock') { %>
                                    <div class="text-emerald-600 uppercase <%= stockChanged ? 'inline-block ring-2 ring-red-500 rounded px-2 py-1' : '' %>">IN STOCK</div>
                                <% } else if(item.availability === 'Back Order') { %>
                                    <div class="text-amber-600 uppercase <%= stockChanged ? 'inline-block ring-2 ring-red-500 rounded px-2 py-1' : '' %>">BACK ORDER</div>
                                <% } else if(item.availability === 'Doggy') { %>
                                    <div class="text-purple-600 uppercase font-bold <%= stockChanged ? 'inline-block ring-2 ring-red-500 rounded px-2 py-1' : '' %>">
                                        <span class="text-xl">üêï</span> DOGGY
                                    </div>
                                    <div class="mt-1 text-[9px] text-purple-900 bg-purple-200 border border-purple-400 rounded px-1 py-0.5">
                                        Invalid Page
                                    </div>
                                <% } else if(item.availability === 'Pending') { %>
                                    <div class="text-slate-400 uppercase italic <%= stockChanged ? 'inline-block ring-2 ring-red-500 rounded px-2 py-1' : '' %>">PENDING</div>
                                <% } else { %>
                                    <div class="text-rose-600 uppercase <%= stockChanged ? 'inline-block ring-2 ring-red-500 rounded px-2 py-1' : '' %>">UNAVAILABLE</div>
                                <% } %>

                                <% if(item.stock_level && item.stock_level.includes('Low Stock')) { %>
                                    <div class="mt-1 text-[9px] text-amber-900 bg-amber-200 border border-amber-400 rounded px-1 py-0.5 animate-pulse">
                                        ‚ö†Ô∏è <%= item.stock_level.replace("Low Stock: ", "") %> left
                                    </div>
                                <% } %>
                            </td>

                            <td class="p-6 text-base font-black seller-cell <%= (item.seller && item.seller.includes('Amazon')) ? 'text-blue-600' : 'text-slate-500' %> <%= (item.changedFields && item.changedFields.includes('seller')) ? 'bg-amber-50' : '' %>" data-seller-val="<%= item.seller %>">
                                <% if (item.changedFields && item.changedFields.includes('seller')) { %>
                                    <span class="inline-block ring-2 ring-red-500 rounded px-2 py-1"><%= item.seller %></span>
                                <% } else { %>
                                    <%= item.seller %>
                                <% } %>
                            </td>

                            <td class="p-6 text-xl font-black text-slate-900 price-cell text-base <%= (item.changedFields && item.changedFields.includes('price')) ? 'bg-amber-50' : '' %>">
                                <% if (item.changedFields && item.changedFields.includes('price')) { %>
                                    <span class="inline-block ring-2 ring-red-500 rounded px-2 py-1"><%= item.price %></span>
                                <% } else { %>
                                    <%= item.price %>
                                <% } %>
                                <% if(item.changedFields && item.changedFields.includes('price') && item.previousPrice) { %>
                                    <%
                                    // Parse prices to calculate difference
                                    const currentPriceMatch = (item.price || '').match(/[\d,]+\.?\d*/);
                                    const previousPriceMatch = (item.previousPrice || '').match(/[\d,]+\.?\d*/);
                                    let priceDiff = null;
                                    let isIncrease = false;
                                    if (currentPriceMatch && previousPriceMatch) {
                                        const currentPrice = parseFloat(currentPriceMatch[0].replace(/,/g, ''));
                                        const previousPrice = parseFloat(previousPriceMatch[0].replace(/,/g, ''));
                                        priceDiff = currentPrice - previousPrice;
                                        isIncrease = priceDiff > 0;
                                    }
                                    %>
                                    <% if(priceDiff !== null && !isNaN(priceDiff)) { %>
                                        <div class="text-xs font-bold mt-1 <%= isIncrease ? 'text-red-600' : 'text-green-600' %>">
                                            <span><%= isIncrease ? '‚Üë' : '‚Üì' %> $<%= Math.abs(priceDiff).toFixed(2) %></span>
                                            <span class="text-slate-400 font-normal ml-1">(was <%= item.previousPrice %>)</span>
                                        </div>
                                    <% } %>
                                <% } %>
                            </td>
                            <!-- Sales Column -->
                            <td class="p-6 text-center text-sm">
                                <% if (item.salesData) { %>
                                    <div class="font-bold text-blue-600"><%= item.salesData.shippedUnits %></div>
                                    <div class="text-[10px] text-slate-500">shipped</div>
                                    <% if (item.salesData.orderedRevenue > 0) { %>
                                    <div class="text-[10px] text-green-600 font-medium">$<%= item.salesData.orderedRevenue.toFixed(0) %></div>
                                    <% } %>
                                <% } else { %>
                                    <span class="text-slate-400">-</span>
                                <% } %>
                            </td>
                            <!-- Traffic Column -->
                            <td class="p-6 text-center text-sm">
                                <% if (item.trafficData && item.trafficData.glanceViews > 0) { %>
                                    <div class="font-bold text-orange-600"><%= item.trafficData.glanceViews.toLocaleString() %></div>
                                    <div class="text-[10px] text-slate-500">views</div>
                                <% } else { %>
                                    <span class="text-slate-400">-</span>
                                <% } %>
                            </td>
                            <!-- Received Column -->
                            <td class="p-6 text-center text-sm">
                                <% if (item.receivingData && item.receivingData.totalOrdered > 0) { %>
                                    <%
                                    const inbound = Math.max(0, item.receivingData.totalOrdered - item.receivingData.totalReceived);
                                    const pctReceived = Math.round((item.receivingData.totalReceived / item.receivingData.totalOrdered) * 100);
                                    %>
                                    <div class="font-bold <%= item.receivingData.totalReceived >= item.receivingData.totalOrdered ? 'text-green-600' : 'text-amber-600' %>">
                                        <%= item.receivingData.totalReceived.toLocaleString() %>
                                    </div>
                                    <div class="text-[10px] text-slate-500"><%= pctReceived %>% of <%= item.receivingData.totalOrdered.toLocaleString() %></div>
                                    <% if (inbound > 0) { %>
                                    <div class="mt-1">
                                        <span class="bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded text-[10px] font-medium">
                                            +<%= inbound.toLocaleString() %> inbound
                                        </span>
                                    </div>
                                    <% } %>
                                <% } else { %>
                                    <span class="text-slate-400">-</span>
                                <% } %>
                            </td>
                            <!-- Last PO Column -->
                            <td class="p-6 text-base">
                                <% if(item.lastPO) { %>
                                    <div class="relative">
                                        <button onclick="togglePODropdown('<%= item.asin %>')" class="text-left hover:bg-slate-100 rounded p-1 transition-colors w-full">
                                            <div class="text-xs font-bold text-slate-700">
                                                <%= new Date(item.lastPO.po_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) %>
                                            </div>
                                            <div class="text-[10px] text-slate-500">
                                                <%= item.poCount %> PO<%= item.poCount !== 1 ? 's' : '' %> ‚ñº
                                            </div>
                                        </button>
                                        <!-- PO Dropdown -->
                                        <div id="po-dropdown-<%= item.asin %>" class="hidden absolute z-50 left-0 top-full mt-1 bg-white border border-slate-300 rounded-lg shadow-lg p-2 min-w-[200px]">
                                            <div class="text-xs font-bold text-slate-500 mb-2 px-2">Recent POs</div>
                                            <div id="po-list-<%= item.asin %>" class="max-h-40 overflow-y-auto">
                                                <div class="text-xs text-slate-400 px-2">Loading...</div>
                                            </div>
                                        </div>
                                    </div>
                                <% } else { %>
                                    <span class="text-slate-400 text-xs">-</span>
                                <% } %>
                            </td>
                            <td class="p-6 text-base">
                                <div class="flex items-center gap-2">
                                    <span class="comment-text"><%= item.comment || '' %></span>
                                    <button data-asin="<%= item.asin %>" onclick="openCommentModalFromButton(this)" class="text-blue-600 hover:text-blue-800 text-sm font-bold">‚úèÔ∏è</button>
                                </div>
                            </td>
                            <td class="p-6 text-base">
                                <%
                                let snoozeOption = '';
                                if (item.snooze_until && item.isSnoozed) {
                                    const snoozeDate = new Date(item.snooze_until);
                                    const now = new Date();
                                    const diff = snoozeDate - now;
                                    const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                                    if (days <= 1) snoozeOption = '1d';
                                    else if (days <= 7) snoozeOption = '1w';
                                    else if (days <= 30) snoozeOption = '1m';
                                    else snoozeOption = 'custom';
                                }
                                %>
                                <select onchange="setSnooze('<%= item.asin %>', this.value)" class="snooze-select border border-slate-300 rounded px-2 py-1 text-sm">
                                    <option value="" <%= snoozeOption === '' ? 'selected' : '' %>>No Snooze</option>
                                    <option value="1d" <%= snoozeOption === '1d' ? 'selected' : '' %>>1 Day</option>
                                    <option value="1w" <%= snoozeOption === '1w' ? 'selected' : '' %>>1 Week</option>
                                    <option value="1m" <%= snoozeOption === '1m' ? 'selected' : '' %>>1 Month</option>
                                    <option value="custom" <%= snoozeOption === 'custom' ? 'selected' : '' %>>Custom Date</option>
                                </select>
                                <% if(item.isSnoozed) { %>
                                    <div class="snooze-badge">
                                        Until <%= new Date(item.snooze_until).toLocaleDateString('en-US', { timeZone: 'America/Montreal', month: 'short', day: 'numeric' }) %>
                                    </div>
                                <% } %>
                            </td>
                            <td class="p-6 text-center text-base">
                                <div class="flex gap-2 justify-center">
                                    <% if(item.hasReports && item.history.length > 0) { %>
                                        <button onclick="event.stopPropagation(); toggleHistory('<%= item.asin %>');" class="px-4 py-2 bg-white text-slate-900 text-[10px] font-black rounded-lg border-2 border-slate-900 hover:bg-slate-900 hover:text-white transition-all history-toggle flex items-center gap-1" data-asin="<%= item.asin %>">
                                            <span>HISTORY</span>
                                            <span class="history-arrow transition-transform duration-200" id="arrow-<%= item.asin %>">‚ñº</span>
                                        </button>
                                    <% } else { %>
                                        <span class="px-4 py-2 bg-slate-200 text-slate-400 text-[10px] font-black rounded-lg border-2 border-slate-300 cursor-not-allowed">NO HISTORY</span>
                                    <% } %>
                                    <button onclick="removeAsin('<%= item.asin %>')" class="px-4 py-2 bg-rose-600 text-white text-[10px] font-black rounded-lg hover:bg-rose-700 transition-all">DELETE</button>
                                </div>
                            </td>
                        </tr>
                        <!-- History row (initially hidden) -->
                        <% if(item.hasReports && item.history.length > 0) { %>
                            <tr id="history-row-<%= item.asin %>" class="history-row hidden bg-slate-50">
                                <td colspan="12" class="p-6">
                                    <div class="bg-white rounded-lg border-2 border-slate-300 shadow-sm p-4">
                                        <div class="mb-4 pb-4 border-b border-slate-300 flex flex-wrap justify-between items-start gap-4">
                                            <div>
                                                <h2 class="text-xl font-bold text-slate-900 mb-2"><%= item.header %></h2>
                                                <h3 class="text-lg font-semibold text-slate-600">History for <span class="font-mono text-blue-600"><%= item.asin %></span> (<%= item.history.length %> entries)</h3>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="showVendorAnalyticsPopup('<%= item.asin %>')" class="px-4 py-2 bg-blue-600 text-white text-xs font-bold rounded-lg hover:bg-blue-700 transition-all flex items-center gap-2">
                                                    <span>üìä</span> Vendor Analytics
                                                </button>
                                                <a href="/catalog/<%= item.asin %>" class="px-4 py-2 bg-slate-600 text-white text-xs font-bold rounded-lg hover:bg-slate-700 transition-all">
                                                    Catalog Info
                                                </a>
                                            </div>
                                        </div>
                                        <div class="overflow-x-auto">
                                            <table class="w-full text-left text-sm">
                                                <thead class="bg-slate-800 text-white text-xs uppercase font-bold">
                                                    <tr>
                                                        <th class="p-3 border-b border-slate-700">Date</th>
                                                        <th class="p-3 border-b border-slate-700">Status</th>
                                                        <th class="p-3 border-b border-slate-700">Stock Level</th>
                                                        <th class="p-3 border-b border-slate-700">Seller</th>
                                                        <th class="p-3 border-b border-slate-700">Price</th>
                                                        <th class="p-3 border-b border-slate-700">Rank</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-slate-200">
                                                    <% item.history.forEach(historyItem => { %>
                                                        <tr class="hover:bg-slate-50 transition-colors">
                                                            <td class="p-3 font-mono text-slate-500"><%= historyItem.check_date_formatted %></td>
                                                            <td class="p-3 font-bold <%= historyItem.isStockChange ? 'text-red-600' : 'text-slate-700' %>"><%= historyItem.availability %></td>
                                                            <td class="p-3 <%= historyItem.isStockChange ? 'text-red-600 font-bold' : 'text-slate-600' %>"><%= historyItem.stock_level %></td>
                                                            <td class="p-3 <%= historyItem.isSellerChange ? 'text-red-600 font-bold' : 'text-slate-600' %>"><%= historyItem.seller %></td>
                                                            <td class="p-3 font-mono <%= historyItem.isPriceChange ? 'bg-red-100 text-red-700 font-bold' : 'text-slate-800' %>"><%= historyItem.price %></td>
                                                            <td class="p-3 text-slate-500"><%= historyItem.ranking %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        <% } %>
                    <% }); %>
                </tbody>
            </table>
            </div>
        </div>
    </div>

    <!-- Add ASIN Modal -->
    <div id="addAsinModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeAddAsinModal()">&times;</span>
            <div class="modal-header">Add New ASIN</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN (10 characters)</label>
                <input type="text" id="newAsinInput" placeholder="B08XYZ1234" maxlength="10" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500 uppercase">
            </div>
            <div class="flex gap-3">
                <button id="addAsinButton" onclick="addAsin()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Add ASIN</button>
                <button onclick="closeAddAsinModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
            <div id="addAsinError" class="mt-3 text-sm font-bold hidden"></div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCommentModal()">&times;</span>
            <div class="modal-header">Edit Comment</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN: <span id="commentAsinDisplay" class="font-mono text-blue-600"></span></label>
                <textarea id="commentTextarea" rows="4" class="w-full px-4 py-2 border-2 border-slate-300 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter comment..."></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="saveComment()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Save</button>
                <button onclick="closeCommentModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Custom Date Picker Modal -->
    <div id="datePickerModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeDatePickerModal()">&times;</span>
            <div class="modal-header">Set Snooze Date</div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">ASIN: <span id="datePickerAsinDisplay" class="font-mono text-blue-600"></span></label>
                <label class="block text-sm font-bold mb-2">Snooze Until:</label>
                <div class="date-picker-wrapper">
                    <input type="datetime-local" id="snoozeDateInput" class="w-full pr-12" min="" max="">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="saveCustomSnooze()" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all text-base">Set Snooze</button>
                <button onclick="clearSnooze()" class="flex-1 bg-rose-600 text-white px-6 py-3 rounded-lg font-black hover:bg-rose-700 transition-all text-base">Clear Snooze</button>
                <button onclick="closeDatePickerModal()" class="flex-1 bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all text-base">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Excel Upload Modal -->
    <div id="excelUploadModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeExcelUploadModal()">&times;</span>
            <div class="modal-header">Upload Excel File</div>

            <!-- Step 1: File Selection -->
            <div id="excelStep1" class="upload-step">
                <div class="step-indicator">
                    <div class="step active">
                        <div class="step-number">1</div>
                        <div>Select File</div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>Import</div>
                    </div>
                </div>
                <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center">
                    <input type="file" id="dashboardExcelFileInput" accept=".xlsx,.xls,.csv,.numbers" class="hidden" onchange="handleDashboardFileSelect(event)">
                    <label for="dashboardExcelFileInput" class="cursor-pointer">
                        <div class="text-4xl mb-4">üìä</div>
                        <div class="text-lg font-bold text-slate-700 mb-2">Click to select file</div>
                        <div class="text-sm text-slate-500">Supports Excel (.xlsx, .xls), CSV (.csv), and Numbers (.numbers - export to CSV/Excel first)</div>
                    </label>
                </div>
                <div id="dashboardFileInfo" class="hidden mt-4 p-4 bg-slate-100 rounded flex items-center justify-between">
                    <div class="font-bold">Selected: <span id="dashboardFileName"></span></div>
                    <button onclick="removeDashboardFile()" class="bg-rose-600 text-white px-4 py-2 rounded-lg font-black hover:bg-rose-700 transition-all text-sm">Remove File</button>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="previewDashboardExcel()" id="dashboardPreviewBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>Preview & Continue</button>
                </div>
            </div>

            <!-- Step 2: Column Mapping -->
            <div id="excelStep2" class="upload-step hidden">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Select File</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">2</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div>Import</div>
                    </div>
                </div>
                <div id="dashboardColumnMappingContent">
                    <div class="mb-4 p-3 bg-slate-100 rounded flex items-center justify-between">
                        <div>
                            <span class="font-bold">File: </span>
                            <span id="dashboardMappingFileName"></span>
                        </div>
                        <button onclick="removeDashboardFileAndGoBack()" class="bg-rose-600 text-white px-4 py-2 rounded-lg font-black hover:bg-rose-700 transition-all text-sm">Remove File</button>
                    </div>
                    <div class="mb-6">
                        <label class="block text-lg font-black text-slate-900 mb-2">Select ASIN Column</label>
                        <p class="text-sm text-slate-600 mb-3">Choose which column contains the ASIN values (10-character product identifiers)</p>
                        <select id="dashboardAsinColumnSelect" class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg text-base focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all font-semibold"></select>
                    </div>
                    <div class="mb-6 p-4 bg-blue-50 border-2 border-blue-200 rounded-lg">
                        <label class="block text-lg font-black text-slate-900 mb-2">Duplicate ASIN Handling</label>
                        <p class="text-sm text-slate-600 mb-3">What should happen when an ASIN already exists in the database?</p>
                        <div class="space-y-2">
                            <label class="flex items-center gap-3 p-3 bg-white border-2 border-blue-300 rounded-lg cursor-pointer hover:bg-blue-50 transition-all">
                                <input type="radio" name="dashboardDuplicateHandling" value="update" checked class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-900">Update Existing</div>
                                    <div class="text-sm text-slate-600">Update existing ASINs with new data from the file</div>
                                </div>
                            </label>
                            <label class="flex items-center gap-3 p-3 bg-white border-2 border-slate-300 rounded-lg cursor-pointer hover:bg-slate-50 transition-all">
                                <input type="radio" name="dashboardDuplicateHandling" value="skip" class="w-5 h-5 text-blue-600 focus:ring-blue-500">
                                <div class="flex-1">
                                    <div class="font-bold text-slate-900">Skip Duplicates</div>
                                    <div class="text-sm text-slate-600">Skip ASINs that already exist in the database</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <div id="dashboardNewColumnsSection" class="hidden">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <label class="block text-lg font-black text-slate-900 mb-1">New Columns to Add</label>
                                    <p class="text-sm text-slate-600">Select which new columns to add to your database</p>
                                </div>
                                <button onclick="autoAddAllNewColumns()" class="px-5 py-2.5 bg-green-600 text-white text-sm font-black rounded-lg hover:bg-green-700 shadow-md hover:shadow-lg transition-all">Auto-Add All</button>
                            </div>
                            <div id="dashboardNewColumnsList" class="space-y-2"></div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-lg font-black text-slate-900 mb-2">Map Excel Columns to Database</label>
                        <p class="text-sm text-slate-600 mb-4">Match your Excel columns to existing database columns. New columns are handled separately above.</p>
                        <div id="dashboardColumnMappingsList" class="space-y-2"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-between">
                    <button onclick="goToDashboardStep(1)" class="bg-slate-300 text-slate-800 px-6 py-3 rounded-lg font-black hover:bg-slate-400 transition-all">Back</button>
                    <button onclick="configureAndImportDashboard()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all">Configure & Import</button>
                </div>
            </div>

            <!-- Step 3: Import Results -->
            <div id="excelStep3" class="upload-step hidden">
                <div class="step-indicator">
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Select File</div>
                    </div>
                    <div class="step completed">
                        <div class="step-number">‚úì</div>
                        <div>Map Columns</div>
                    </div>
                    <div class="step active">
                        <div class="step-number">3</div>
                        <div>Import</div>
                    </div>
                </div>
                <div id="dashboardImportResults" class="mt-4">
                    <div class="p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                        <div class="font-bold mb-2">Import Complete!</div>
                        <div id="dashboardImportStats"></div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="closeExcelUploadModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-black hover:bg-blue-700 transition-all">Done</button>
                </div>
            </div>
            <div id="dashboardUploadError" class="hidden mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded"></div>
        </div>
    </div>

    <!-- Vendor Analytics Popup Modal -->
    <div id="vendorAnalyticsModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="modal-close" onclick="closeVendorAnalyticsModal()">&times;</span>
            <div class="modal-header">
                <span>Vendor Analytics for </span>
                <span id="vaAsinDisplay" class="font-mono text-blue-600"></span>
            </div>
            <div id="vaProductTitle" class="text-sm text-slate-500 mb-4"></div>

            <!-- Metrics Summary Cards -->
            <div id="vaMetricsSummary" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="text-xs text-blue-600 font-medium">Ordered Units</div>
                    <div id="vaOrderedUnits" class="text-xl font-black text-blue-700">-</div>
                </div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="text-xs text-green-600 font-medium">Revenue</div>
                    <div id="vaRevenue" class="text-xl font-black text-green-700">-</div>
                </div>
                <div class="p-3 bg-orange-50 rounded-lg border border-orange-200">
                    <div class="text-xs text-orange-600 font-medium">Glance Views</div>
                    <div id="vaGlanceViews" class="text-xl font-black text-orange-700">-</div>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <div class="text-xs text-purple-600 font-medium">Inventory</div>
                    <div id="vaInventory" class="text-xl font-black text-purple-700">-</div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="mb-6">
                <!-- Time Range Selection -->
                <div class="flex flex-wrap items-center gap-2 mb-3">
                    <span class="text-xs text-slate-500 font-medium">Period:</span>
                    <div class="flex flex-wrap gap-1">
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 hover:bg-blue-100" data-days="1">1D</button>
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 hover:bg-blue-100" data-days="7">1W</button>
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-blue-600 text-white" data-days="30">30D</button>
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 hover:bg-blue-100" data-days="90">90D</button>
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 hover:bg-blue-100" data-days="365">1Y</button>
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 hover:bg-blue-100" data-days="1095">All</button>
                        <button class="va-period-btn px-2 py-1 text-xs rounded bg-slate-200 text-slate-600 hover:bg-blue-100" data-days="custom">Custom</button>
                    </div>
                    <div id="vaCustomDates" class="hidden flex items-center gap-1 ml-2">
                        <input type="date" id="vaStartDate" class="px-2 py-1 text-xs border border-slate-300 rounded" onchange="updateVendorAnalyticsChart()">
                        <span class="text-xs text-slate-400">to</span>
                        <input type="date" id="vaEndDate" class="px-2 py-1 text-xs border border-slate-300 rounded" onchange="updateVendorAnalyticsChart()">
                    </div>
                </div>

                <!-- Metric Selection -->
                <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                    <div class="flex flex-wrap gap-1">
                        <label class="flex items-center gap-1 px-2 py-1 bg-blue-50 border border-blue-200 rounded text-xs cursor-pointer hover:bg-blue-100">
                            <input type="checkbox" class="va-metric-cb" value="orderedUnits" checked onchange="updateVendorAnalyticsChart()">
                            <span>Units</span>
                        </label>
                        <label class="flex items-center gap-1 px-2 py-1 bg-green-50 border border-green-200 rounded text-xs cursor-pointer hover:bg-green-100">
                            <input type="checkbox" class="va-metric-cb" value="orderedRevenue" checked onchange="updateVendorAnalyticsChart()">
                            <span>Revenue</span>
                        </label>
                        <label class="flex items-center gap-1 px-2 py-1 bg-orange-50 border border-orange-200 rounded text-xs cursor-pointer hover:bg-orange-100">
                            <input type="checkbox" class="va-metric-cb" value="glanceViews" checked onchange="updateVendorAnalyticsChart()">
                            <span>Views</span>
                        </label>
                        <label class="flex items-center gap-1 px-2 py-1 bg-purple-50 border border-purple-200 rounded text-xs cursor-pointer hover:bg-purple-100">
                            <input type="checkbox" class="va-metric-cb" value="sellableOnHandInventoryUnits" checked onchange="updateVendorAnalyticsChart()">
                            <span>Inventory</span>
                        </label>
                    </div>
                    <button onclick="resetVaChartZoom()" class="px-2 py-1 text-xs bg-slate-200 text-slate-600 rounded hover:bg-slate-300">Reset Zoom</button>
                </div>

                <div id="vaChartContainer" style="height: 280px; position: relative;">
                    <canvas id="vaChart"></canvas>
                    <div id="vaChartLoading" class="absolute inset-0 flex items-center justify-center bg-slate-50 rounded-lg">
                        <div class="text-slate-500">Loading chart data...</div>
                    </div>
                </div>
                <div class="text-xs text-slate-400 mt-1 text-center">Click and drag to zoom, double-click to reset</div>
            </div>

            <!-- Purchase Orders for this ASIN -->
            <div class="mb-4">
                <h4 class="font-bold text-slate-800 mb-3">Purchase Orders</h4>
                <div id="vaPurchaseOrders" class="max-h-48 overflow-auto">
                    <div class="text-slate-500 text-sm">Loading...</div>
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <a id="vaFullAnalyticsLink" href="/vendor-analytics" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-bold hover:bg-slate-300 transition-all text-sm">
                    View Full Analytics
                </a>
                <button onclick="closeVendorAnalyticsModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-all text-sm">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const terminal = document.getElementById('terminal-stream');
        const container = document.getElementById('status-container');
        const syncStatus = document.getElementById('sync-status');
        const runBtn = document.getElementById('run-btn');
        const stopBtn = document.getElementById('stop-btn');
        const lastSyncTimeEl = document.getElementById('last-sync-time');

        let itemsProcessed = 0;
        let totalItems = 0;

        socket.on('scraper-log', (msg) => {
            if (container.classList.contains('hidden')) container.classList.remove('hidden');
            if (msg.includes('Processing')) {
                const match = msg.match(/\d+/);
                if (match) {
                    totalItems = parseInt(match[0]);
                    itemsProcessed = 0; // Reset counter for new report
                }
            }
            if (msg.includes('-->')) itemsProcessed++;
            if (totalItems > 0) syncStatus.innerText = `RUNNING: ${itemsProcessed} / ${totalItems}`;

            const line = document.createElement('div');
            line.className = "border-l-2 border-slate-700 pl-3 mb-1 py-0.5 font-mono text-[11px] leading-relaxed hover:bg-slate-800";
            if (msg.includes('In Stock')) line.classList.add('text-emerald-400');
            else if (msg.includes('Back Order')) line.classList.add('text-amber-400');
            else if (msg.includes('Unavailable')) line.classList.add('text-rose-400');
            else line.classList.add('text-slate-300');

            const montrealTime = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Montreal' });
            line.innerText = `[${montrealTime}] ${msg}`;
            terminal.appendChild(line);
            terminal.scrollTop = terminal.scrollHeight;
        });

        socket.on('scraper-done', (newTime) => {
            syncStatus.innerText = 'üèÅ COMPLETE';
            runBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            document.getElementById('run-selected-btn').disabled = false;
            updateRunSelectedButton(); // Update button text
            if(newTime) lastSyncTimeEl.innerText = newTime;

            const reloadPrompt = document.createElement('div');
            reloadPrompt.className = "mt-4 p-3 bg-blue-900/30 border border-blue-500 rounded text-blue-200 text-center font-bold animate-pulse cursor-pointer";
            reloadPrompt.innerText = "Scan Finished! Click to refresh.";
            reloadPrompt.onclick = () => window.location.reload();
            terminal.appendChild(reloadPrompt);
        });

        async function runReport() {
            itemsProcessed = 0;
            totalItems = 0;
            container.classList.remove('hidden');
            runBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            document.getElementById('run-selected-btn').disabled = true;
            terminal.innerHTML = '<div class="text-amber-400 font-bold mb-2">Connecting...</div>';
            await fetch('/run-report', { method: 'POST' });
        }

        async function stopReport() {
            if(confirm("Stop the scraper?")) {
                runBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
                syncStatus.innerText = "STOPPING...";
                await fetch('/stop-report', { method: 'POST' });
            }
        }

        // Price sorting state
        let priceSortState = 'none'; // 'none', 'asc', 'desc'
        let currentAsinForComment = null;
        let currentAsinForSnooze = null;

        // Selection management
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.asin-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateRunSelectedButton();
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll('.asin-checkbox');
            const selectAll = document.getElementById('selectAll');
            const checkedCount = document.querySelectorAll('.asin-checkbox:checked').length;
            selectAll.checked = checkedCount === checkboxes.length && checkboxes.length > 0;
            selectAll.indeterminate = checkedCount > 0 && checkedCount < checkboxes.length;
            updateRunSelectedButton();
        }

        function updateRunSelectedButton() {
            const checkedCount = document.querySelectorAll('.asin-checkbox:checked').length;
            const runSelectedBtn = document.getElementById('run-selected-btn');
            if (checkedCount > 0) {
                runSelectedBtn.disabled = false;
                runSelectedBtn.textContent = `RUN ON SELECTED (${checkedCount})`;
            } else {
                runSelectedBtn.disabled = true;
                runSelectedBtn.textContent = 'RUN ON SELECTED';
            }
        }

        async function runReportOnSelected() {
            const checkedBoxes = document.querySelectorAll('.asin-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select at least one ASIN');
                return;
            }

            const asins = Array.from(checkedBoxes).map(cb => cb.value);

            if (!confirm(`Run report on ${asins.length} selected ASIN${asins.length > 1 ? 's' : ''}?`)) {
                return;
            }

            const runSelectedBtn = document.getElementById('run-selected-btn');
            const runBtn = document.getElementById('run-btn');
            const stopBtn = document.getElementById('stop-btn');
            const container = document.getElementById('status-container');
            const terminal = document.getElementById('terminal-stream');
            const syncStatus = document.getElementById('sync-status');

            try {
                runSelectedBtn.disabled = true;
                runBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                container.classList.remove('hidden');
                syncStatus.innerText = `RUNNING: 0 / ${asins.length}`;
                terminal.innerHTML = '<div class="text-amber-400 font-bold mb-2">Starting report on selected ASINs...</div>';

                const response = await fetch('/run-report-selected', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asins })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start report');
                }
            } catch (err) {
                alert('Error: ' + err.message);
                runSelectedBtn.disabled = false;
                runBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            }
        }

        // ASIN Management
        function openAddAsinModal() {
            document.getElementById('addAsinModal').style.display = 'block';
            document.getElementById('newAsinInput').value = '';
            document.getElementById('addAsinError').classList.add('hidden');
            document.getElementById('newAsinInput').focus();
        }

        function closeAddAsinModal() {
            document.getElementById('addAsinModal').style.display = 'none';
        }

        async function addAsin() {
            const asin = document.getElementById('newAsinInput').value.trim().toUpperCase();
            const errorDiv = document.getElementById('addAsinError');
            const addButton = document.getElementById('addAsinButton');
            const originalText = addButton.textContent;

            if (!asin || asin.length !== 10) {
                errorDiv.textContent = 'ASIN must be exactly 10 characters';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Show loading state
            addButton.disabled = true;
            addButton.textContent = 'Adding...';
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/asins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asin })
                });

                const data = await response.json();
                if (response.ok) {
                    closeAddAsinModal();
                    // Immediately reload to show new ASIN
                    window.location.reload();
                } else {
                    errorDiv.textContent = data.error || 'Failed to add ASIN';
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.remove('text-green-600');
                    errorDiv.classList.add('text-red-600');
                    addButton.disabled = false;
                    addButton.textContent = originalText;
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.classList.remove('hidden');
                errorDiv.classList.remove('text-green-600');
                errorDiv.classList.add('text-red-600');
                addButton.disabled = false;
                addButton.textContent = originalText;
            }
        }

        async function removeAsin(asin) {
            if (!confirm(`Are you sure you want to remove ASIN ${asin}?`)) return;

            try {
                const response = await fetch(`/api/asins/${asin}`, { method: 'DELETE' });
                if (response.ok) {
                    // Immediately reload to show removal
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to remove ASIN'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Comment Management
        function openCommentModalFromButton(button) {
            const asin = button.dataset.asin;
            const commentText = button.previousElementSibling.textContent;
            openCommentModal(asin, commentText);
        }

        function openCommentModal(asin, currentComment) {
            currentAsinForComment = asin;
            document.getElementById('commentAsinDisplay').textContent = asin;
            document.getElementById('commentTextarea').value = currentComment || '';
            document.getElementById('commentModal').style.display = 'block';
            document.getElementById('commentTextarea').focus();
        }

        function closeCommentModal() {
            document.getElementById('commentModal').style.display = 'none';
            currentAsinForComment = null;
        }

        async function saveComment() {
            if (!currentAsinForComment) return;

            const comment = document.getElementById('commentTextarea').value.trim();

            try {
                const response = await fetch(`/api/asins/${currentAsinForComment}/comment`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment })
                });

                if (response.ok) {
                    closeCommentModal();
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to save comment'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Snooze Management
        function setSnooze(asin, option) {
            currentAsinForSnooze = asin;

            if (option === 'custom') {
                document.getElementById('datePickerAsinDisplay').textContent = asin;
                document.getElementById('datePickerModal').style.display = 'block';

                const dateInput = document.getElementById('snoozeDateInput');

                // Set min to now (prevent past dates)
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const minValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                dateInput.min = minValue;

                // Set max to 1 year from now (prevent infinite scrolling)
                const maxDate = new Date();
                maxDate.setFullYear(maxDate.getFullYear() + 1);
                const maxYear = maxDate.getFullYear();
                const maxMonth = String(maxDate.getMonth() + 1).padStart(2, '0');
                const maxDay = String(maxDate.getDate()).padStart(2, '0');
                const maxHours = String(maxDate.getHours()).padStart(2, '0');
                const maxMinutes = String(maxDate.getMinutes()).padStart(2, '0');
                const maxValue = `${maxYear}-${maxMonth}-${maxDay}T${maxHours}:${maxMinutes}`;
                dateInput.max = maxValue;

                // Set default to tomorrow in local time
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowYear = tomorrow.getFullYear();
                const tomorrowMonth = String(tomorrow.getMonth() + 1).padStart(2, '0');
                const tomorrowDay = String(tomorrow.getDate()).padStart(2, '0');
                const tomorrowHours = String(tomorrow.getHours()).padStart(2, '0');
                const tomorrowMinutes = String(tomorrow.getMinutes()).padStart(2, '0');
                dateInput.value = `${tomorrowYear}-${tomorrowMonth}-${tomorrowDay}T${tomorrowHours}:${tomorrowMinutes}`;
            } else if (option === '') {
                clearSnooze();
            } else {
                let date = new Date();
                if (option === '1d') date.setDate(date.getDate() + 1);
                else if (option === '1w') date.setDate(date.getDate() + 7);
                else if (option === '1m') date.setMonth(date.getMonth() + 1);

                saveSnooze(asin, date.toISOString());
            }
        }

        function closeDatePickerModal() {
            document.getElementById('datePickerModal').style.display = 'none';
            currentAsinForSnooze = null;
        }

        async function saveCustomSnooze() {
            if (!currentAsinForSnooze) return;

            const dateValue = document.getElementById('snoozeDateInput').value;
            if (!dateValue) {
                alert('Please select a date');
                return;
            }

            // datetime-local gives local time, convert to ISO string for storage
            // Create date from local time string (browser interprets as local)
            const localDate = new Date(dateValue);
            // Convert to ISO string for storage (server expects UTC)
            await saveSnooze(currentAsinForSnooze, localDate.toISOString());
        }

        async function clearSnooze() {
            if (!currentAsinForSnooze) return;

            await saveSnooze(currentAsinForSnooze, null);
        }

        async function saveSnooze(asin, snoozeUntil) {
            try {
                const response = await fetch(`/api/asins/${asin}/snooze`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snooze_until: snoozeUntil })
                });

                if (response.ok) {
                    closeDatePickerModal();
                    window.location.reload();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Failed to set snooze'));
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Price Sorting
        function sortByPrice() {
            const rows = Array.from(document.querySelectorAll('.inventory-row'));
            const indicator = document.getElementById('priceSortIndicator');

            // Toggle sort state
            if (priceSortState === 'none') priceSortState = 'asc';
            else if (priceSortState === 'asc') priceSortState = 'desc';
            else priceSortState = 'none';

            // Update indicator
            if (priceSortState === 'asc') indicator.textContent = '‚Üë';
            else if (priceSortState === 'desc') indicator.textContent = '‚Üì';
            else indicator.textContent = '‚Üï';

            if (priceSortState === 'none') {
                // Reload page to get default sort
                window.location.reload();
                return;
            }

            // Separate snoozed and non-snoozed items
            const snoozed = rows.filter(r => r.classList.contains('opacity-60'));
            const notSnoozed = rows.filter(r => !r.classList.contains('opacity-60'));

            // Sort non-snoozed items by price
            notSnoozed.sort((a, b) => {
                const priceA = parsePrice(a.getAttribute('data-price'));
                const priceB = parsePrice(b.getAttribute('data-price'));
                return priceSortState === 'asc' ? priceA - priceB : priceB - priceA;
            });

            // Reorder: non-snoozed (sorted) first, then snoozed
            const tbody = document.getElementById('tableBody');

            // Collect history rows before clearing
            const historyRows = {};
            document.querySelectorAll('.history-row').forEach(hr => {
                const asin = hr.id.replace('history-row-', '');
                historyRows[asin] = hr;
            });

            tbody.innerHTML = '';
            let idx = 1;
            notSnoozed.forEach((row) => {
                const numCell = row.querySelector('td:nth-child(2)');
                if (numCell) numCell.textContent = idx++;
                tbody.appendChild(row);
                // Re-append history row if exists
                const asin = row.getAttribute('data-asin');
                if (asin && historyRows[asin]) {
                    tbody.appendChild(historyRows[asin]);
                }
            });
            snoozed.forEach((row) => {
                const numCell = row.querySelector('td:nth-child(2)');
                if (numCell) numCell.textContent = idx++;
                tbody.appendChild(row);
                // Re-append history row if exists
                const asin = row.getAttribute('data-asin');
                if (asin && historyRows[asin]) {
                    tbody.appendChild(historyRows[asin]);
                }
            });
        }

        function parsePrice(priceStr) {
            if (!priceStr || priceStr === 'N/A') return 0;
            // Remove currency symbols and extract number
            const match = priceStr.match(/[\d,]+\.?\d*/);
            if (!match) return 0;
            return parseFloat(match[0].replace(/,/g, ''));
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addAsinModal');
            const commentModal = document.getElementById('commentModal');
            const dateModal = document.getElementById('datePickerModal');
            if (event.target === addModal) closeAddAsinModal();
            if (event.target === commentModal) closeCommentModal();
            if (event.target === dateModal) closeDatePickerModal();
        }

        // Multi-select status filter
        let selectedStatuses = ['all'];

        function toggleStatusDropdown(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('statusDropdown');
            const button = document.getElementById('statusFilterBtn');
            if (!dropdown || !button) {
                return;
            }

            const isHidden = dropdown.classList.contains('hidden');

            // Close all other dropdowns first
            document.querySelectorAll('[id^="statusDropdown"]').forEach(dd => {
                if (dd !== dropdown) {
                    dd.classList.add('hidden');
                }
            });

            if (isHidden) {
                dropdown.classList.remove('hidden');

                // Calculate position to keep dropdown within viewport
                const buttonRect = button.getBoundingClientRect();
                const dropdownRect = dropdown.getBoundingClientRect();
                const viewportWidth = window.innerWidth;

                // Reset positioning
                dropdown.style.left = '0';
                dropdown.style.right = 'auto';

                // Check if dropdown would overflow right edge
                if (buttonRect.left + dropdownRect.width > viewportWidth) {
                    // Position from right edge instead
                    dropdown.style.left = 'auto';
                    dropdown.style.right = '0';
                }

                // Check if dropdown would overflow left edge
                const finalRect = dropdown.getBoundingClientRect();
                if (finalRect.left < 0) {
                    dropdown.style.left = '0';
                    dropdown.style.right = 'auto';
                }
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function updateStatusFilter(event) {
            // #region agent log
            const debugInfo = {
                timestamp: Date.now(),
                event: 'updateStatusFilter',
                clickedElement: event?.target?.value || 'unknown'
            };
            console.log('[STATUS FILTER DEBUG] Function called', debugInfo);
            // #endregion

            const checkboxes = document.querySelectorAll('.status-checkbox');
            const allCheckbox = document.querySelector('.status-checkbox[value="all"]');
            const otherCheckboxes = Array.from(checkboxes).filter(cb => cb.value !== 'all');

            // #region agent log
            debugInfo.allCheckboxChecked = allCheckbox ? allCheckbox.checked : null;
            debugInfo.otherCheckboxesState = otherCheckboxes.map(cb => ({
                value: cb.value,
                checked: cb.checked
            }));
            console.log('[STATUS FILTER DEBUG] Initial state', debugInfo);
            // #endregion

            selectedStatuses = [];

            // Determine which checkbox was clicked
            const clickedCheckbox = event?.target;
            const clickedValue = clickedCheckbox?.value;

            // If a non-"all" checkbox was clicked while "all" is checked, uncheck "all" first
            if (clickedValue && clickedValue !== 'all' && allCheckbox && allCheckbox.checked) {
                // #region agent log
                debugInfo.action = 'nonAllClickedWhileAllChecked - unchecking all first';
                console.log('[STATUS FILTER DEBUG] Non-all checkbox clicked while all is checked', debugInfo);
                // #endregion

                allCheckbox.checked = false;
            }

            // If "all" checkbox was clicked and is now checked, check all others too
            if (clickedValue === 'all' && allCheckbox && allCheckbox.checked) {
                // #region agent log
                debugInfo.action = 'allClickedAndChecked - checking all others';
                console.log('[STATUS FILTER DEBUG] All was clicked and is checked, checking all others', debugInfo);
                // #endregion

                // Check all other checkboxes
                otherCheckboxes.forEach(cb => cb.checked = true);
                // Collect all statuses
                selectedStatuses = ['all', ...otherCheckboxes.map(cb => cb.value)];
                const statusText = document.getElementById('statusFilterText');
                if (statusText) statusText.textContent = 'ALL';
            } else if (allCheckbox && allCheckbox.checked && clickedValue !== 'all') {
                // "All" is checked but a non-"all" checkbox was clicked - uncheck "all" first
                // #region agent log
                debugInfo.action = 'nonAllClickedWhileAllChecked - unchecking all first';
                console.log('[STATUS FILTER DEBUG] Non-all clicked while all is checked', debugInfo);
                // #endregion

                allCheckbox.checked = false;
                // Continue to process the clicked checkbox
                otherCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedStatuses.push(cb.value);
                    }
                });

                if (selectedStatuses.length === 0) {
                    if (allCheckbox) allCheckbox.checked = true;
                    selectedStatuses = ['all'];
                    const statusText = document.getElementById('statusFilterText');
                    if (statusText) statusText.textContent = 'ALL';
                } else {
                    const count = selectedStatuses.length;
                    const statusText = document.getElementById('statusFilterText');
                    if (statusText) {
                        statusText.textContent = count === 1 ? selectedStatuses[0].replace(/_/g, ' ') : `${count} Selected`;
                    }
                }
            } else {
                // #region agent log
                debugInfo.action = 'allNotChecked - collecting other selections';
                // #endregion

                // "All" is not checked - collect selected statuses from other checkboxes
                otherCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        selectedStatuses.push(cb.value);
                    }
                });

                // #region agent log
                debugInfo.selectedStatusesBeforeDefault = [...selectedStatuses];
                // #endregion

                // If nothing is selected, default to "all"
                if (selectedStatuses.length === 0) {
                    // #region agent log
                    debugInfo.action = 'nothingSelected - defaulting to all';
                    console.log('[STATUS FILTER DEBUG] Nothing selected, defaulting to all', debugInfo);
                    // #endregion

                    if (allCheckbox) allCheckbox.checked = true;
                    selectedStatuses = ['all'];
                    const statusText = document.getElementById('statusFilterText');
                    if (statusText) statusText.textContent = 'ALL';
                } else {
                    // #region agent log
                    debugInfo.action = 'otherCheckboxesSelected';
                    // #endregion

                    // Ensure "all" is unchecked when other checkboxes are selected
                    if (allCheckbox) allCheckbox.checked = false;
                    const count = selectedStatuses.length;
                    const statusText = document.getElementById('statusFilterText');
                    if (statusText) {
                        statusText.textContent = count === 1 ? selectedStatuses[0].replace(/_/g, ' ') : `${count} Selected`;
                    }
                }
            }

            // #region agent log
            debugInfo.finalSelectedStatuses = [...selectedStatuses];
            debugInfo.finalAllChecked = allCheckbox ? allCheckbox.checked : null;
            debugInfo.finalOtherCheckboxesState = otherCheckboxes.map(cb => ({
                value: cb.value,
                checked: cb.checked
            }));
            console.log('[STATUS FILTER DEBUG] Final state', debugInfo);
            // #endregion

            applyFilters();
        }

        // Close dropdown when clicking outside - use capture phase to check before event propagates
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('statusDropdown');
            const button = document.getElementById('statusFilterBtn');
            if (dropdown && button) {
                // Check if click is on a checkbox or label inside dropdown
                const isInsideDropdown = dropdown.contains(event.target);
                const isOnButton = button.contains(event.target);

                if (!isInsideDropdown && !isOnButton) {
                    dropdown.classList.add('hidden');
                }
            }
        }, true); // Use capture phase

        function applyFilters() {
            // #region agent log
            const filterDebug = {
                timestamp: Date.now(),
                search: document.getElementById('searchInput').value.toLowerCase(),
                seller: document.getElementById('sellerFilter').value,
                selectedStatuses: [...selectedStatuses],
                scrollYBefore: window.scrollY
            };
            console.log('[APPLY FILTERS DEBUG] Starting filter application', filterDebug);
            // #endregion

            // Save current scroll position to prevent jumping
            const scrollPosition = window.scrollY;

            const search = document.getElementById('searchInput').value.toLowerCase();
            const seller = document.getElementById('sellerFilter').value;

            const rows = document.querySelectorAll('.inventory-row');
            let visibleCount = 0;

            rows.forEach(row => {
                const title = row.querySelector('.title-cell').innerText.toLowerCase();
                const asin = row.querySelector('.asin-cell').innerText.toLowerCase();
                const stockVal = row.querySelector('.stock-cell').getAttribute('data-availability-val') || "";
                const stockLevelVal = row.querySelector('.stock-cell').getAttribute('data-stocklevel-val') || "";
                const sellerVal = row.querySelector('.seller-cell').getAttribute('data-seller-val') || "";

                const matchSearch = title.includes(search) || asin.includes(search);

                // Multi-select status matching
                let matchStock = true;
                if (!selectedStatuses.includes('all')) {
                    matchStock = false;
                    for (const status of selectedStatuses) {
                        if (status === 'LOW STOCK' && stockLevelVal.includes('LOW STOCK')) {
                            matchStock = true;
                            break;
                        } else if (status === 'DOGGY' && stockVal === 'DOGGY') {
                            matchStock = true;
                            break;
                        } else if (status === 'PENDING' && stockVal === 'PENDING') {
                            matchStock = true;
                            break;
                        } else if (stockVal === status.toUpperCase()) {
                            matchStock = true;
                            break;
                        }
                    }
                }

                let matchSeller = true;
                if (seller === 'Amazon') matchSeller = sellerVal.includes('Amazon');
                if (seller === '3rd Party') matchSeller = sellerVal.includes('3rd Party');

                if (matchSearch && matchStock && matchSeller) {
                    row.classList.remove('hidden-row');
                    visibleCount++;
                    // Also show/hide history rows if they exist
                    const asinValue = row.getAttribute('data-asin');
                    if (asinValue) {
                        const historyRow = document.getElementById(`history-row-${asinValue}`);
                        if (historyRow && !historyRow.classList.contains('hidden')) {
                            historyRow.classList.remove('hidden-row');
                        }
                    }
                } else {
                    row.classList.add('hidden-row');
                    // Hide history rows when parent is hidden
                    const asinValue = row.getAttribute('data-asin');
                    if (asinValue) {
                        const historyRow = document.getElementById(`history-row-${asinValue}`);
                        if (historyRow) {
                            historyRow.classList.add('hidden-row');
                        }
                    }
                }
            });

            // #region agent log
            filterDebug.visibleCount = visibleCount;
            filterDebug.totalRows = rows.length;
            console.log('[APPLY FILTERS DEBUG] Filter complete', filterDebug);
            // #endregion

            // Table always stays visible - no "no results" message to avoid layout issues
        }

        // History toggle function
        function toggleHistory(asin) {
            const historyRow = document.getElementById(`history-row-${asin}`);
            const toggleBtn = document.querySelector(`.history-toggle[data-asin="${asin}"]`);
            const arrow = document.getElementById(`arrow-${asin}`);

            if (!historyRow) {
                console.error(`History row not found for ASIN: ${asin}`);
                alert(`History not available for ${asin}. Please refresh the page.`);
                return;
            }

            if (historyRow) {
                // Check both 'hidden' (Tailwind) and 'hidden-row' (filter) classes
                const isHidden = historyRow.classList.contains('hidden');
                const isFilteredOut = historyRow.classList.contains('hidden-row');

                if (isHidden || isFilteredOut) {
                    // Show history - remove BOTH hiding classes
                    historyRow.classList.remove('hidden');
                    historyRow.classList.remove('hidden-row'); // Also remove filter class if present

                    const historyText = toggleBtn?.querySelector('span:first-child');
                    if (historyText) historyText.textContent = 'HIDE HISTORY';
                    if (toggleBtn) {
                        toggleBtn.classList.remove('bg-white', 'text-slate-900');
                        toggleBtn.classList.add('bg-slate-900', 'text-white');
                    }
                    if (arrow) {
                        arrow.textContent = '‚ñ≤';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                } else {
                    // Hide history
                    historyRow.classList.add('hidden');

                    const historyText = toggleBtn?.querySelector('span:first-child');
                    if (historyText) historyText.textContent = 'HISTORY';
                    if (toggleBtn) {
                        toggleBtn.classList.remove('bg-slate-900', 'text-white');
                        toggleBtn.classList.add('bg-white', 'text-slate-900');
                    }
                    if (arrow) {
                        arrow.textContent = '‚ñº';
                        arrow.style.transform = 'rotate(0deg)';
                    }
                }
            }
        }

        // Check scraper status on page load
        async function checkScraperStatus() {
            // #region agent log
            const debugInfo = {
                timestamp: Date.now(),
                location: 'index.ejs:checkScraperStatus',
                message: 'Checking scraper status on page load',
                data: {
                    stopBtnExists: !!stopBtn,
                    stopBtnHidden: stopBtn ? stopBtn.classList.contains('hidden') : null
                },
                sessionId: 'debug-session',
                runId: 'run1',
                hypothesisId: 'A'
            };
            fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(debugInfo)}).catch(()=>{});
            // #endregion
            try {
                const response = await fetch('/api/scraper-status');
                const data = await response.json();
                // #region agent log
                const debugInfo2 = {
                    timestamp: Date.now(),
                    location: 'index.ejs:checkScraperStatus',
                    message: 'Received scraper status response',
                    data: {
                        running: data.running,
                        stopBtnExists: !!stopBtn,
                        stopBtnHiddenBefore: stopBtn ? stopBtn.classList.contains('hidden') : null
                    },
                    sessionId: 'debug-session',
                    runId: 'run1',
                    hypothesisId: 'A'
                };
                fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(debugInfo2)}).catch(()=>{});
                // #endregion
                if (data.running) {
                    // Scraper is running - show stop button and hide run button
                    runBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    container.classList.remove('hidden');
                    document.getElementById('run-selected-btn').disabled = true;
                    syncStatus.innerText = 'RUNNING';
                    // #region agent log
                    const debugInfo3 = {
                        timestamp: Date.now(),
                        location: 'index.ejs:checkScraperStatus',
                        message: 'Scraper is running - showing stop button',
                        data: {
                            stopBtnHiddenAfter: stopBtn.classList.contains('hidden'),
                            runBtnHiddenAfter: runBtn.classList.contains('hidden')
                        },
                        sessionId: 'debug-session',
                        runId: 'run1',
                        hypothesisId: 'A'
                    };
                    fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(debugInfo3)}).catch(()=>{});
                    // #endregion
                } else {
                    // Scraper is not running - ensure stop button is hidden
                    runBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    document.getElementById('run-selected-btn').disabled = false;
                    // #region agent log
                    const debugInfo4 = {
                        timestamp: Date.now(),
                        location: 'index.ejs:checkScraperStatus',
                        message: 'Scraper is not running - hiding stop button',
                        data: {
                            stopBtnHiddenAfter: stopBtn.classList.contains('hidden'),
                            runBtnHiddenAfter: runBtn.classList.contains('hidden')
                        },
                        sessionId: 'debug-session',
                        runId: 'run1',
                        hypothesisId: 'A'
                    };
                    fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(debugInfo4)}).catch(()=>{});
                    // #endregion
                }
            } catch (err) {
                // #region agent log
                const debugInfo5 = {
                    timestamp: Date.now(),
                    location: 'index.ejs:checkScraperStatus',
                    message: 'Error checking scraper status',
                    data: {
                        error: err.message
                    },
                    sessionId: 'debug-session',
                    runId: 'run1',
                    hypothesisId: 'A'
                };
                fetch('http://127.0.0.1:7242/ingest/fda94e7d-8ef6-44ca-a90c-9c591fc930f3',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(debugInfo5)}).catch(()=>{});
                // #endregion
                console.error('Error checking scraper status:', err);
            }
        }

        // Excel Upload Functions
        let dashboardExcelFile = null;
        let dashboardPreviewData = null;

        function openExcelUploadModal() {
            document.getElementById('excelUploadModal').style.display = 'block';
            goToDashboardStep(1);
        }

        function closeExcelUploadModal() {
            document.getElementById('excelUploadModal').style.display = 'none';
            removeDashboardFile(); // Clear file and reset state
            dashboardPreviewData = null;
            goToDashboardStep(1); // Reset to step 1
        }

        function goToDashboardStep(step) {
            document.querySelectorAll('.upload-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`excelStep${step}`).classList.remove('hidden');
        }

        function handleDashboardFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                dashboardExcelFile = file;
                document.getElementById('dashboardFileName').textContent = file.name;
                document.getElementById('dashboardFileInfo').classList.remove('hidden');
                document.getElementById('dashboardPreviewBtn').disabled = false;
                document.getElementById('dashboardUploadError').classList.add('hidden');
            }
        }

        function removeDashboardFile() {
            dashboardExcelFile = null;
            dashboardPreviewData = null;
            document.getElementById('dashboardExcelFileInput').value = '';
            document.getElementById('dashboardFileName').textContent = '';
            document.getElementById('dashboardFileInfo').classList.add('hidden');
            document.getElementById('dashboardPreviewBtn').disabled = true;
            document.getElementById('dashboardUploadError').classList.add('hidden');
        }

        function removeDashboardFileAndGoBack() {
            removeDashboardFile();
            goToDashboardStep(1);
        }

        async function previewDashboardExcel() {
            if (!dashboardExcelFile) return;

            const formData = new FormData();
            formData.append('file', dashboardExcelFile);

            try {
                document.getElementById('dashboardUploadError').classList.add('hidden');
                const response = await fetch('/api/upload-excel/preview', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    let errorMsg = data.error || 'Failed to preview file';
                    if (data.suggestion) {
                        errorMsg += '\n\n' + data.suggestion;
                    }
                    throw new Error(errorMsg);
                }

                dashboardPreviewData = data;
                // Update file name in step 2
                if (dashboardExcelFile) {
                    document.getElementById('dashboardMappingFileName').textContent = dashboardExcelFile.name;
                }
                renderDashboardColumnMapping();
                goToDashboardStep(2);
            } catch (err) {
                const errorDiv = document.getElementById('dashboardUploadError');
                errorDiv.innerHTML = 'Error: ' + err.message.replace(/\n/g, '<br>');
                errorDiv.classList.remove('hidden');
            }
        }

        function renderDashboardColumnMapping() {
            if (!dashboardPreviewData) return;

            // ASIN column select - show ALL columns, not just detected ASIN
            const asinSelect = document.getElementById('dashboardAsinColumnSelect');
            asinSelect.innerHTML = '';
            dashboardPreviewData.excelColumns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.index;
                option.textContent = col.name;
                if (col.isAsin) {
                    option.selected = true;
                }
                asinSelect.appendChild(option);
            });

            // New columns section
            if (dashboardPreviewData.newColumns && dashboardPreviewData.newColumns.length > 0) {
                document.getElementById('dashboardNewColumnsSection').classList.remove('hidden');
                const newColsList = document.getElementById('dashboardNewColumnsList');
                newColsList.innerHTML = '';

                // Add header with Select All / Deselect All buttons
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-center mb-4 pb-3 border-b-2 border-slate-300';
                headerDiv.innerHTML = `
                    <div>
                        <div class="font-black text-lg text-slate-900">New Columns to Add</div>
                        <div class="text-sm text-slate-600 mt-1">${dashboardPreviewData.newColumns.length} column(s) will be added to your database</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="selectAllNewColumns()" class="px-4 py-2 bg-blue-600 text-white text-sm font-black rounded-lg hover:bg-blue-700 shadow-md transition-all">Select All</button>
                        <button onclick="deselectAllNewColumns()" class="px-4 py-2 bg-slate-400 text-white text-sm font-black rounded-lg hover:bg-slate-500 shadow-md transition-all">Deselect All</button>
                    </div>
                `;
                newColsList.appendChild(headerDiv);

                dashboardPreviewData.newColumns.forEach(col => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-3 p-4 bg-gradient-to-r from-slate-50 to-blue-50 border-2 border-slate-200 rounded-lg mb-2 hover:border-blue-300 transition-all';
                    div.innerHTML = `
                        <input type="checkbox" id="dashboardNewCol_${col.sanitizedName}" class="dashboard-new-col-checkbox w-5 h-5 cursor-pointer" data-name="${col.name}" data-sanitized="${col.sanitizedName}" data-type="${col.suggestedType}" checked>
                        <label for="dashboardNewCol_${col.sanitizedName}" class="flex-1 cursor-pointer">
                            <div class="font-black text-slate-900 mb-1">${col.name}</div>
                            <div class="text-sm text-slate-600">
                                <span class="font-semibold">Database name:</span> <span class="font-mono text-blue-700">${col.sanitizedName}</span>
                                <span class="mx-2">‚Ä¢</span>
                                <span class="font-semibold">Type:</span> <span class="text-blue-700">${col.suggestedType}</span>
                            </div>
                        </label>
                    `;
                    newColsList.appendChild(div);
                });
            } else {
                document.getElementById('dashboardNewColumnsSection').classList.add('hidden');
            }

            // Column mappings - only show columns that are NOT new columns
            const mappingsList = document.getElementById('dashboardColumnMappingsList');
            mappingsList.innerHTML = '';

            // Get list of new column names for filtering
            const newColumnNames = new Set((dashboardPreviewData.newColumns || []).map(col => col.name.toLowerCase()));

            // Filter out new columns and ASIN from mapping list
            const columnsToMap = dashboardPreviewData.excelColumns.filter(col =>
                !col.isAsin && !newColumnNames.has(col.name.toLowerCase())
            );

            // Count auto-matched columns
            const suggestedMappings = dashboardPreviewData.suggestedMappings || {};
            let autoMatchedCount = 0;
            let unmatchedCount = 0;

            columnsToMap.forEach(col => {
                const hasMatch = suggestedMappings[col.name];
                if (hasMatch) autoMatchedCount++;
                else unmatchedCount++;
            });

            // Add summary and Auto-Map All button
            if (columnsToMap.length > 0) {
                const summaryDiv = document.createElement('div');
                summaryDiv.className = 'mb-4 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl flex justify-between items-center shadow-sm';
                summaryDiv.innerHTML = `
                    <div class="text-sm">
                        <div class="font-black text-blue-900 text-base mb-1">Column Mapping Summary</div>
                        <div class="text-slate-700">
                            <span class="font-bold text-green-700">${autoMatchedCount} auto-matched</span>
                            ${unmatchedCount > 0 ? `<span class="text-slate-600"> ‚Ä¢ ${unmatchedCount} need manual mapping</span>` : '<span class="text-green-600"> ‚Ä¢ All columns mapped!</span>'}
                        </div>
                    </div>
                    <button onclick="autoMapAllColumns()" class="px-5 py-2.5 bg-blue-600 text-white text-sm font-black rounded-lg hover:bg-blue-700 shadow-md hover:shadow-lg transition-all">Auto-Map All</button>
                `;
                mappingsList.appendChild(summaryDiv);
            }

            if (columnsToMap.length === 0) {
                const noMappingDiv = document.createElement('div');
                noMappingDiv.className = 'p-6 bg-slate-50 border-2 border-slate-200 rounded-xl text-center';
                noMappingDiv.innerHTML = `
                    <div class="text-4xl mb-3">‚úÖ</div>
                    <div class="font-bold text-slate-700 mb-1">All columns are new!</div>
                    <div class="text-sm text-slate-500">New columns will be added to the database above.</div>
                `;
                mappingsList.appendChild(noMappingDiv);
            } else {
                columnsToMap.forEach(col => {
                    const suggestedMatch = suggestedMappings[col.name];
                    const isAutoMatched = !!suggestedMatch;

                    const div = document.createElement('div');
                    div.className = `flex items-center gap-3 p-3 bg-white border-2 rounded-lg mb-2 transition-all ${isAutoMatched ? 'border-green-300 bg-green-50 shadow-sm' : 'border-amber-200 bg-amber-50 shadow-sm'}`;
                    div.innerHTML = `
                        <div class="flex-shrink-0">
                            ${isAutoMatched ? '<span class="text-green-600 text-xl">‚úì</span>' : '<span class="text-amber-600 text-xl">‚ö†</span>'}
                        </div>
                        <label class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-black text-slate-900">${col.name}</span>
                                ${isAutoMatched ? '<span class="text-xs text-green-700 font-bold bg-green-100 px-2 py-0.5 rounded">Auto-matched</span>' : '<span class="text-xs text-amber-700 font-bold bg-amber-100 px-2 py-0.5 rounded">Needs mapping</span>'}
                            </div>
                            <select class="dashboard-column-mapping-select w-full px-3 py-2 border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all" data-excel-col="${col.name}">
                                <option value="">-- Skip this column --</option>
                                ${dashboardPreviewData.existingColumns.map(dbCol => {
                                    const isSelected = suggestedMatch === dbCol.name;
                                    return `<option value="${dbCol.name}" ${isSelected ? 'selected' : ''}>${dbCol.name}</option>`;
                                }).join('')}
                            </select>
                        </label>
                    `;
                    mappingsList.appendChild(div);
                });
            }
        }

        function selectAllNewColumns() {
            document.querySelectorAll('.dashboard-new-col-checkbox').forEach(cb => {
                cb.checked = true;
            });
        }

        function deselectAllNewColumns() {
            document.querySelectorAll('.dashboard-new-col-checkbox').forEach(cb => {
                cb.checked = false;
            });
        }

        function autoMapAllColumns() {
            if (!dashboardPreviewData || !dashboardPreviewData.suggestedMappings) return;

            const suggestedMappings = dashboardPreviewData.suggestedMappings;
            document.querySelectorAll('.dashboard-column-mapping-select').forEach(select => {
                const excelCol = select.dataset.excelCol;
                const suggestedMatch = suggestedMappings[excelCol];
                if (suggestedMatch) {
                    select.value = suggestedMatch;
                }
            });
        }

        function autoAddAllNewColumns() {
            const newColumns = dashboardPreviewData?.newColumns || [];
            if (newColumns.length === 0) {
                alert('No new columns to add');
                return;
            }

            if (confirm(`This will add ${newColumns.length} new column(s) to your database:\n\n${newColumns.map(c => `- ${c.name} (${c.suggestedType})`).join('\n')}\n\nContinue?`)) {
                // Select all new columns
                selectAllNewColumns();
                // Proceed with import (this will be handled by configureAndImportDashboard)
            }
        }

        async function configureAndImportDashboard() {
            const asinColumnIndex = document.getElementById('dashboardAsinColumnSelect').value;
            if (!asinColumnIndex) {
                alert('Please select ASIN column');
                return;
            }

            // Collect new columns to add
            const newColumnsToAdd = [];
            document.querySelectorAll('.dashboard-new-col-checkbox:checked').forEach(cb => {
                newColumnsToAdd.push({
                    name: cb.dataset.name,
                    type: cb.dataset.type
                });
            });

            // Collect column mappings
            const mappings = {};
            document.querySelectorAll('.dashboard-column-mapping-select').forEach(select => {
                const excelCol = select.dataset.excelCol;
                const dbCol = select.value;
                if (dbCol) {
                    mappings[excelCol] = dbCol;
                }
            });

            // Get duplicate handling preference
            const duplicateHandling = document.querySelector('input[name="dashboardDuplicateHandling"]:checked')?.value || 'update';

            try {
                document.getElementById('dashboardUploadError').classList.add('hidden');

                // Step 1: Add new columns if any
                if (newColumnsToAdd.length > 0) {
                    const configureResponse = await fetch('/api/upload-excel/configure', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ columnsToAdd: newColumnsToAdd })
                    });

                    const configureData = await configureResponse.json();
                    if (!configureResponse.ok) {
                        throw new Error(configureData.error || 'Failed to configure columns');
                    }

                    // Update mappings with newly added columns
                    configureData.addedColumns.forEach(col => {
                        const excelCol = newColumnsToAdd.find(nc => sanitizeDashboardColumnName(nc.name) === col.dbName);
                        if (excelCol) {
                            mappings[excelCol.name] = col.dbName;
                        }
                    });
                }

                // Step 2: Import data
                const formData = new FormData();
                formData.append('file', dashboardExcelFile);
                formData.append('asinColumnIndex', asinColumnIndex);
                formData.append('columnMappings', JSON.stringify(mappings));
                formData.append('duplicateHandling', duplicateHandling);

                const importResponse = await fetch('/api/upload-excel/import', {
                    method: 'POST',
                    body: formData
                });

                const importData = await importResponse.json();
                if (!importResponse.ok) {
                    throw new Error(importData.error || 'Failed to import data');
                }

                // Show results
                document.getElementById('dashboardImportStats').innerHTML = `
                    <div class="space-y-2">
                        <div class="font-bold text-lg mb-3">Import Results:</div>
                        <div class="flex items-center gap-2">
                            <span class="text-green-700 font-bold">‚úì Added:</span>
                            <span class="text-lg font-black">${importData.stats.added}</span>
                        </div>
                        ${duplicateHandling === 'update' ? `
                            <div class="flex items-center gap-2">
                                <span class="text-blue-700 font-bold">‚Üª Updated:</span>
                                <span class="text-lg font-black">${importData.stats.updated}</span>
                            </div>
                        ` : ''}
                        <div class="flex items-center gap-2">
                            <span class="text-slate-600 font-bold">‚äò Skipped:</span>
                            <span class="text-lg font-black">${importData.stats.skipped}</span>
                        </div>
                        ${importData.errors && importData.errors.length > 0 ?
                            `<div class="mt-3 p-3 bg-red-50 border border-red-300 rounded">
                                <div class="font-bold text-red-700">Errors: ${importData.errors.length}</div>
                                <div class="text-sm text-red-600 mt-1 max-h-32 overflow-y-auto">
                                    ${importData.errors.slice(0, 5).map(e => `<div>‚Ä¢ ${e}</div>`).join('')}
                                    ${importData.errors.length > 5 ? `<div>... and ${importData.errors.length - 5} more</div>` : ''}
                                </div>
                            </div>` : ''}
                    </div>
                `;
                goToDashboardStep(3);

                // Reload page after 2 seconds to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } catch (err) {
                document.getElementById('dashboardUploadError').textContent = 'Error: ' + err.message;
                document.getElementById('dashboardUploadError').classList.remove('hidden');
            }
        }

        function sanitizeDashboardColumnName(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9_]/g, '_')
                .replace(/_{2,}/g, '_')
                .replace(/^_|_$/g, '');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateSelectAllState();
            checkScraperStatus(); // Check if scraper is running on page load

            // Initialize date picker constraints to prevent infinite scrolling
            const dateInput = document.getElementById('snoozeDateInput');
            if (dateInput) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                dateInput.min = `${year}-${month}-${day}T${hours}:${minutes}`;

                const maxDate = new Date();
                maxDate.setFullYear(maxDate.getFullYear() + 1);
                const maxYear = maxDate.getFullYear();
                const maxMonth = String(maxDate.getMonth() + 1).padStart(2, '0');
                const maxDay = String(maxDate.getDate()).padStart(2, '0');
                const maxHours = String(maxDate.getHours()).padStart(2, '0');
                const maxMinutes = String(maxDate.getMinutes()).padStart(2, '0');
                dateInput.max = `${maxYear}-${maxMonth}-${maxDay}T${maxHours}:${maxMinutes}`;
            }
        });

        // Vendor Analytics Popup Functions
        let vaChart = null;
        let currentVaAsin = null;
        let vaSelectedDays = 30; // Default 30 days

        async function showVendorAnalyticsPopup(asin) {
            currentVaAsin = asin;
            vaSelectedDays = 30; // Reset to default
            document.getElementById('vaAsinDisplay').textContent = asin;
            document.getElementById('vaFullAnalyticsLink').href = `/vendor-analytics?asin=${asin}`;
            document.getElementById('vendorAnalyticsModal').style.display = 'block';
            document.getElementById('vaChartLoading').classList.remove('hidden');

            // Reset period buttons
            document.querySelectorAll('.va-period-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-slate-200', 'text-slate-600');
                if (btn.dataset.days === '30') {
                    btn.classList.remove('bg-slate-200', 'text-slate-600');
                    btn.classList.add('bg-blue-600', 'text-white');
                }
            });
            document.getElementById('vaCustomDates').classList.add('hidden');

            // Check all metric checkboxes by default
            document.querySelectorAll('.va-metric-cb').forEach(cb => cb.checked = true);

            // Reset display
            document.getElementById('vaProductTitle').textContent = 'Loading...';
            document.getElementById('vaOrderedUnits').textContent = '-';
            document.getElementById('vaRevenue').textContent = '-';
            document.getElementById('vaGlanceViews').textContent = '-';
            document.getElementById('vaInventory').textContent = '-';
            document.getElementById('vaPurchaseOrders').innerHTML = '<div class="text-slate-500 text-sm">Loading...</div>';

            // Setup period button handlers
            setupVaPeriodButtons();

            // Fetch data
            await Promise.all([
                loadVendorAnalyticsSummary(asin),
                loadAsinPurchaseOrders(asin),
                updateVendorAnalyticsChart()
            ]);
        }

        function setupVaPeriodButtons() {
            document.querySelectorAll('.va-period-btn').forEach(btn => {
                btn.onclick = () => {
                    // Update button styles
                    document.querySelectorAll('.va-period-btn').forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white');
                        b.classList.add('bg-slate-200', 'text-slate-600');
                    });
                    btn.classList.remove('bg-slate-200', 'text-slate-600');
                    btn.classList.add('bg-blue-600', 'text-white');

                    // Handle custom date range
                    if (btn.dataset.days === 'custom') {
                        document.getElementById('vaCustomDates').classList.remove('hidden');
                        // Set default custom dates
                        const end = new Date();
                        const start = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                        document.getElementById('vaEndDate').value = end.toISOString().split('T')[0];
                        document.getElementById('vaStartDate').value = start.toISOString().split('T')[0];
                        vaSelectedDays = 'custom';
                    } else {
                        document.getElementById('vaCustomDates').classList.add('hidden');
                        vaSelectedDays = parseInt(btn.dataset.days);
                    }
                    updateVendorAnalyticsChart();
                };
            });
        }

        function resetVaChartZoom() {
            if (vaChart) vaChart.resetZoom();
        }

        function closeVendorAnalyticsModal() {
            document.getElementById('vendorAnalyticsModal').style.display = 'none';
            if (vaChart) {
                vaChart.destroy();
                vaChart = null;
            }
        }

        async function loadVendorAnalyticsSummary(asin) {
            try {
                let startDate, endDate;
                if (vaSelectedDays === 'custom') {
                    startDate = document.getElementById('vaStartDate').value;
                    endDate = document.getElementById('vaEndDate').value;
                } else {
                    endDate = new Date().toISOString().split('T')[0];
                    startDate = new Date(Date.now() - vaSelectedDays * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                }

                const response = await fetch(`/api/vendor-analytics/data?asin=${asin}&startDate=${startDate}&endDate=${endDate}`);
                const data = await response.json();

                if (data.success) {
                    document.getElementById('vaProductTitle').textContent = data.title || '';
                    document.getElementById('vaOrderedUnits').textContent = data.orderedUnits !== undefined ? data.orderedUnits.toLocaleString() : '-';
                    document.getElementById('vaRevenue').textContent = data.revenue !== undefined ? '$' + data.revenue.toFixed(2) : '-';
                    document.getElementById('vaGlanceViews').textContent = data.glanceViews !== undefined ? data.glanceViews.toLocaleString() : '-';
                    document.getElementById('vaInventory').textContent = data.inventory !== undefined ? data.inventory.toLocaleString() : '-';
                } else {
                    document.getElementById('vaProductTitle').textContent = 'No data available';
                }
            } catch (err) {
                console.error('Error loading vendor analytics summary:', err);
            }
        }

        async function loadAsinPurchaseOrders(asin) {
            try {
                const response = await fetch(`/api/purchase-orders/by-asin/${asin}`);
                const data = await response.json();

                if (data.success && data.purchaseOrders.length > 0) {
                    const rows = data.purchaseOrders.map(po => `
                        <tr class="hover:bg-slate-50 text-xs">
                            <td class="px-2 py-1 font-mono font-bold text-blue-600">${po.po_number}</td>
                            <td class="px-2 py-1">${new Date(po.po_date).toLocaleDateString('en-CA')}</td>
                            <td class="px-2 py-1"><span class="px-2 py-0.5 rounded text-xs font-medium ${
                                po.po_status === 'Shipped' || po.po_status === 'Closed' ? 'bg-green-100 text-green-700' :
                                po.po_status === 'Acknowledged' ? 'bg-amber-100 text-amber-700' :
                                po.po_status === 'Cancelled' ? 'bg-red-100 text-red-700' :
                                'bg-blue-100 text-blue-700'
                            }">${po.po_status}</span></td>
                            <td class="px-2 py-1 text-right">${po.ordered_quantity || '-'}</td>
                            <td class="px-2 py-1 text-right">${po.acknowledged_quantity || '-'}</td>
                            <td class="px-2 py-1 text-right">${po.net_cost_amount ? '$' + parseFloat(po.net_cost_amount).toFixed(2) : '-'}</td>
                        </tr>
                    `).join('');

                    document.getElementById('vaPurchaseOrders').innerHTML = `
                        <table class="w-full text-left border border-slate-200 rounded">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="px-2 py-1 text-xs font-bold">PO#</th>
                                    <th class="px-2 py-1 text-xs font-bold">Date</th>
                                    <th class="px-2 py-1 text-xs font-bold">Status</th>
                                    <th class="px-2 py-1 text-xs font-bold text-right">Ordered</th>
                                    <th class="px-2 py-1 text-xs font-bold text-right">Accepted</th>
                                    <th class="px-2 py-1 text-xs font-bold text-right">Cost</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-200">${rows}</tbody>
                        </table>
                        <div class="text-xs text-slate-500 mt-2">${data.purchaseOrders.length} purchase order${data.purchaseOrders.length !== 1 ? 's' : ''}</div>
                    `;
                } else {
                    document.getElementById('vaPurchaseOrders').innerHTML = '<div class="text-slate-400 text-sm">No purchase orders found for this ASIN</div>';
                }
            } catch (err) {
                console.error('Error loading purchase orders:', err);
                document.getElementById('vaPurchaseOrders').innerHTML = '<div class="text-red-500 text-sm">Error loading purchase orders</div>';
            }
        }

        async function updateVendorAnalyticsChart() {
            if (!currentVaAsin) return;

            // Get selected metrics from checkboxes
            const selectedMetrics = Array.from(document.querySelectorAll('.va-metric-cb:checked')).map(cb => cb.value);
            if (selectedMetrics.length === 0) {
                document.getElementById('vaChartLoading').classList.remove('hidden');
                document.getElementById('vaChartLoading').innerHTML = '<div class="text-slate-500">Select at least one metric</div>';
                if (vaChart) { vaChart.destroy(); vaChart = null; }
                return;
            }

            // Calculate date range based on selected period
            let startDate, endDate;
            if (vaSelectedDays === 'custom') {
                startDate = document.getElementById('vaStartDate').value;
                endDate = document.getElementById('vaEndDate').value;
                if (!startDate || !endDate) return;
            } else {
                endDate = new Date().toISOString().split('T')[0];
                startDate = new Date(Date.now() - vaSelectedDays * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            }

            document.getElementById('vaChartLoading').classList.remove('hidden');
            document.getElementById('vaChartLoading').innerHTML = '<div class="text-slate-500">Loading chart data...</div>';

            try {
                // Fetch data for each metric
                const allDatasets = [];
                const chartColors = {
                    orderedUnits: '#3b82f6',
                    orderedRevenue: '#10b981',
                    glanceViews: '#f59e0b',
                    sellableOnHandInventoryUnits: '#8b5cf6'
                };
                const metricLabels = {
                    orderedUnits: 'Units',
                    orderedRevenue: 'Revenue',
                    glanceViews: 'Views',
                    sellableOnHandInventoryUnits: 'Inventory'
                };

                let allDates = [];

                for (const metric of selectedMetrics) {
                    const response = await fetch(`/api/vendor-analytics/chart-data?asins=${currentVaAsin}&metric=${metric}&startDate=${startDate}&endDate=${endDate}`);
                    const data = await response.json();

                    if (data.success && data.dates.length > 0) {
                        if (allDates.length === 0) allDates = data.dates;

                        allDatasets.push({
                            label: metricLabels[metric],
                            data: data.series[0]?.values || [],
                            borderColor: chartColors[metric],
                            backgroundColor: chartColors[metric] + '20',
                            tension: 0.3,
                            fill: selectedMetrics.length === 1,
                            yAxisID: metric.includes('Revenue') ? 'yRevenue' : 'y'
                        });
                    }
                }

                document.getElementById('vaChartLoading').classList.add('hidden');

                if (allDatasets.length === 0) {
                    document.getElementById('vaChartLoading').classList.remove('hidden');
                    document.getElementById('vaChartLoading').innerHTML = '<div class="text-slate-500">No chart data available for this period</div>';
                    return;
                }

                if (vaChart) vaChart.destroy();

                const ctx = document.getElementById('vaChart').getContext('2d');
                const hasRevenue = selectedMetrics.includes('orderedRevenue');
                const hasOtherMetrics = selectedMetrics.some(m => m !== 'orderedRevenue');

                vaChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: allDates,
                        datasets: allDatasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: allDatasets.length > 1, position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        let value = ctx.raw;
                                        if (ctx.dataset.label.includes('Revenue')) value = '$' + value.toFixed(2);
                                        else value = value.toLocaleString();
                                        return ctx.dataset.label + ': ' + value;
                                    }
                                }
                            },
                            zoom: {
                                zoom: {
                                    wheel: { enabled: true },
                                    pinch: { enabled: true },
                                    drag: { enabled: true, backgroundColor: 'rgba(59, 130, 246, 0.1)', borderColor: '#3b82f6', borderWidth: 1 },
                                    mode: 'x'
                                },
                                pan: { enabled: true, mode: 'x' }
                            }
                        },
                        scales: {
                            x: { title: { display: false } },
                            y: {
                                type: 'linear',
                                display: hasOtherMetrics,
                                position: 'left',
                                beginAtZero: true,
                                title: { display: false }
                            },
                            yRevenue: {
                                type: 'linear',
                                display: hasRevenue && hasOtherMetrics,
                                position: 'right',
                                beginAtZero: true,
                                grid: { drawOnChartArea: false },
                                title: { display: false }
                            }
                        }
                    }
                });

                // Also reload summary when date range changes
                loadVendorAnalyticsSummary(currentVaAsin);
            } catch (err) {
                console.error('Error updating chart:', err);
                document.getElementById('vaChartLoading').classList.remove('hidden');
                document.getElementById('vaChartLoading').innerHTML = '<div class="text-red-500">Error loading chart</div>';
            }
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const addModal = document.getElementById('addAsinModal');
            const commentModal = document.getElementById('commentModal');
            const dateModal = document.getElementById('datePickerModal');
            const excelModal = document.getElementById('excelUploadModal');
            const vaModal = document.getElementById('vendorAnalyticsModal');
            if (event.target === addModal) closeAddAsinModal();
            if (event.target === commentModal) closeCommentModal();
            if (event.target === dateModal) closeDatePickerModal();
            if (event.target === excelModal) closeExcelUploadModal();
            if (event.target === vaModal) closeVendorAnalyticsModal();

            // Close PO dropdowns when clicking outside
            if (!event.target.closest('[id^="po-dropdown-"]') && !event.target.closest('[onclick*="togglePODropdown"]')) {
                document.querySelectorAll('[id^="po-dropdown-"]').forEach(dd => dd.classList.add('hidden'));
            }
        }

        // PO Dropdown Functions
        let activePODropdown = null;

        async function togglePODropdown(asin) {
            const dropdown = document.getElementById('po-dropdown-' + asin);
            const isHidden = dropdown.classList.contains('hidden');

            // Close all dropdowns first
            document.querySelectorAll('[id^="po-dropdown-"]').forEach(dd => dd.classList.add('hidden'));

            if (isHidden) {
                dropdown.classList.remove('hidden');
                activePODropdown = asin;

                // Fetch PO list for this ASIN
                try {
                    const response = await fetch('/api/purchase-orders/by-asin/' + asin);
                    const data = await response.json();
                    const listEl = document.getElementById('po-list-' + asin);

                    if (data.success && data.purchaseOrders.length > 0) {
                        listEl.innerHTML = data.purchaseOrders.slice(0, 10).map(po => `
                            <div class="px-2 py-1 hover:bg-slate-100 rounded text-xs cursor-pointer" onclick="window.location.href='/purchase-orders?po=${po.po_number}'">
                                <div class="font-bold text-blue-600">${po.po_number}</div>
                                <div class="text-slate-500 flex justify-between">
                                    <span>${new Date(po.po_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' })}</span>
                                    <span class="font-medium">${po.ordered_quantity || '-'} units</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        listEl.innerHTML = '<div class="text-xs text-slate-400 px-2">No POs found</div>';
                    }
                } catch (err) {
                    console.error('Error fetching POs:', err);
                    document.getElementById('po-list-' + asin).innerHTML = '<div class="text-xs text-red-500 px-2">Error loading POs</div>';
                }
            } else {
                activePODropdown = null;
            }
        }

        // ============================================
        // Date Range Picker Calendar
        // ============================================
        let calendarDate = new Date();
        let rangeStartDate = null;
        let rangeEndDate = null;
        let currentPreset = 'all'; // Default to "all" (shows all rows, no date filtering)

        // Initialize with "all" preset on page load
        document.addEventListener('DOMContentLoaded', function() {
            setDatePreset('all');
        });

        function toggleDateRangePicker() {
            const picker = document.getElementById('dateRangePicker');
            const btn = document.getElementById('dateRangeBtn');
            const calendarSection = document.getElementById('calendarSection');

            picker.classList.toggle('hidden');
            if (!picker.classList.contains('hidden')) {
                // Position the picker below the button using fixed positioning
                const rect = btn.getBoundingClientRect();
                picker.style.top = (rect.bottom + 8) + 'px';
                picker.style.left = rect.left + 'px';

                // Hide calendar section initially (only show when Custom Range is clicked)
                if (calendarSection) {
                    calendarSection.classList.add('hidden');
                }

                updatePresetButtons();
            }
        }

        function showCustomCalendar(event) {
            if (event) {
                event.stopPropagation();
            }
            const calendarSection = document.getElementById('calendarSection');
            if (calendarSection) {
                calendarSection.classList.remove('hidden');
                currentPreset = 'custom';
                renderCalendar();
            }
        }

        // Close picker when clicking outside (but not when clicking inside the calendar)
        // Set up after DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Use mousedown instead of click to prevent issues with date selection
            document.addEventListener('mousedown', function(e) {
                const picker = document.getElementById('dateRangePicker');
                const btn = document.getElementById('dateRangeBtn');
                // Don't close if clicking inside the picker or button
                // Also don't interfere with other buttons/links
                if (picker && !picker.classList.contains('hidden') &&
                    !picker.contains(e.target) && !btn.contains(e.target)) {
                    // Only close if the click is not on a button or interactive element
                    const target = e.target;
                    const isButton = target.tagName === 'BUTTON' || target.closest('button');
                    const isLink = target.tagName === 'A' || target.closest('a');
                    const isInput = target.tagName === 'INPUT' || target.closest('input');

                    // Don't close if clicking on buttons, links, or inputs (except the date picker button)
                    if (!isButton && !isLink && !isInput) {
                        picker.classList.add('hidden');
                    }
                }
            });

            // Prevent clicks inside the picker from closing it
            const picker = document.getElementById('dateRangePicker');
            if (picker) {
                picker.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });

        function changeCalendarMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const calendarSection = document.getElementById('calendarSection');
            // Only render if calendar section is visible
            if (calendarSection && calendarSection.classList.contains('hidden')) {
                return;
            }

            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            document.getElementById('calendarMonthYear').textContent = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();

            const daysContainer = document.getElementById('calendarDays');
            daysContainer.innerHTML = '';

            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                daysContainer.innerHTML += '<div class="py-2"></div>';
            }

            // Days of month
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0);

                const isToday = date.getTime() === today.getTime();
                const isSelected = isDateSelected(date);
                const isInRange = isDateInRange(date);
                const isStart = rangeStartDate && date.getTime() === rangeStartDate.getTime();
                const isEnd = rangeEndDate && date.getTime() === rangeEndDate.getTime();

                let classes = 'py-2 rounded-lg cursor-pointer transition-all hover:bg-orange-100';

                if (isStart || isEnd) {
                    classes += ' bg-orange-600 text-white font-bold hover:bg-orange-700';
                } else if (isInRange) {
                    classes += ' bg-orange-200 text-orange-800';
                } else if (isToday) {
                    classes += ' border-2 border-orange-400 font-bold';
                }

                daysContainer.innerHTML += `<div class="${classes}" onclick="selectDate(${year}, ${month}, ${day}); event.stopPropagation();">${day}</div>`;
            }

            updateSelectedRangeDisplay();
            updatePresetButtons();
        }

        function isDateSelected(date) {
            if (!rangeStartDate) return false;
            if (rangeStartDate && date.getTime() === rangeStartDate.getTime()) return true;
            if (rangeEndDate && date.getTime() === rangeEndDate.getTime()) return true;
            return false;
        }

        function isDateInRange(date) {
            if (!rangeStartDate || !rangeEndDate) return false;
            return date > rangeStartDate && date < rangeEndDate;
        }

        function selectDate(year, month, day) {
            const date = new Date(year, month, day);
            date.setHours(0, 0, 0, 0);

            if (!rangeStartDate || (rangeStartDate && rangeEndDate)) {
                // First click or resetting
                rangeStartDate = date;
                rangeEndDate = null;
                currentPreset = 'custom';
            } else {
                // Second click
                if (date < rangeStartDate) {
                    rangeEndDate = rangeStartDate;
                    rangeStartDate = date;
                } else {
                    rangeEndDate = date;
                }
                // Set end date to end of day
                rangeEndDate.setHours(23, 59, 59, 999);
                currentPreset = 'custom';
            }

            renderCalendar();
            // Don't close the picker - keep it open so user can see both dates selected
            // Make sure picker stays visible
            const picker = document.getElementById('dateRangePicker');
            if (picker) {
                picker.classList.remove('hidden');
            }
        }

        function setDatePreset(preset) {
            const now = new Date();
            const calendarSection = document.getElementById('calendarSection');

            currentPreset = preset;

            switch(preset) {
                case 'all':
                    rangeStartDate = null;
                    rangeEndDate = null;
                    break;
                case '24h':
                    rangeStartDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    rangeEndDate = now;
                    break;
                case '48h':
                    rangeStartDate = new Date(now.getTime() - 48 * 60 * 60 * 1000);
                    rangeEndDate = now;
                    break;
                case '7d':
                    rangeStartDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    rangeEndDate = now;
                    break;
                case '30d':
                    rangeStartDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    rangeEndDate = now;
                    break;
            }

            // Hide calendar section for preset buttons (only show for custom)
            if (calendarSection && preset !== 'custom') {
                calendarSection.classList.add('hidden');
            }

            updatePresetButtons();
            applyDateRangeFilter();
            updateDateRangeLabel();
        }

        function updatePresetButtons() {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                if (btn.dataset.preset === currentPreset) {
                    btn.classList.add('bg-orange-600', 'text-white');
                    btn.classList.remove('bg-slate-100');
                } else {
                    btn.classList.remove('bg-orange-600', 'text-white');
                    btn.classList.add('bg-slate-100');
                }
            });
        }

        function updateSelectedRangeDisplay() {
            const display = document.getElementById('selectedRangeDisplay');
            if (!rangeStartDate) {
                display.textContent = 'Click to select start date, then end date';
            } else if (!rangeEndDate) {
                display.innerHTML = `<span class="text-orange-600 font-bold">Start:</span> ${formatDateShort(rangeStartDate)} <span class="text-slate-400">‚Üí Select end date</span>`;
            } else {
                display.innerHTML = `<span class="text-orange-600 font-bold">${formatDateShort(rangeStartDate)}</span> ‚Üí <span class="text-orange-600 font-bold">${formatDateShort(rangeEndDate)}</span>`;
            }
        }

        function formatDateShort(date) {
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function clearDateRange() {
            rangeStartDate = null;
            rangeEndDate = null;
            currentPreset = 'all';
            renderCalendar();
            applyDateRangeFilter();
            updateDateRangeLabel();
        }

        function applyDateRangeAndClose() {
            applyDateRangeFilter();
            updateDateRangeLabel();
            document.getElementById('dateRangePicker').classList.add('hidden');
        }

        function updateDateRangeLabel() {
            const label = document.getElementById('dateRangeLabel');
            if (!rangeStartDate) {
                label.textContent = 'All Updates';
            } else if (currentPreset !== 'custom') {
                const presetLabels = { '24h': 'Last 24 Hours', '48h': 'Last 48 Hours', '7d': 'Last 7 Days', '30d': 'Last 30 Days' };
                label.textContent = presetLabels[currentPreset] || 'All Updates';
            } else {
                label.textContent = `${formatDateShort(rangeStartDate)} - ${rangeEndDate ? formatDateShort(rangeEndDate) : '...'}`;
            }

            // Remove any existing count badge
            const badge = label.querySelector('span.bg-orange-600');
            if (badge) {
                badge.remove();
            }
        }

        function applyDateRangeFilter() {
            const rows = Array.from(document.querySelectorAll('.inventory-row'));
            const tbody = document.getElementById('tableBody');
            const hasFilter = rangeStartDate && rangeEndDate;

            rows.forEach(row => {
                const hasChanged = row.dataset.hasChanged === 'true';
                const checkDateStr = row.dataset.checkDate;

                // Remove any previous filter highlighting
                row.classList.remove('ring-2', 'ring-orange-400', 'bg-orange-50', 'matched-filter');

                if (!hasFilter) {
                    // No filter - show all, keep normal styling
                    row.classList.remove('hidden-by-filter');
                    row.style.display = '';
                } else if (checkDateStr) {
                    // Check if this row's update falls within the date range
                    const checkDate = new Date(checkDateStr);
                    const afterStart = checkDate >= rangeStartDate;
                    const beforeEnd = checkDate <= rangeEndDate;

                    if (afterStart && beforeEnd) {
                        // Matches filter - show it and highlight in orange
                        row.classList.remove('hidden-by-filter');
                        row.style.display = '';
                        row.classList.add('matched-filter', 'ring-2', 'ring-orange-400', 'bg-orange-50');
                    } else {
                        // Doesn't match - still show but not highlighted
                        row.classList.remove('hidden-by-filter');
                        row.style.display = '';
                    }
                } else {
                    // No check_date - show it
                    row.classList.remove('hidden-by-filter');
                    row.style.display = '';
                }
            });

            // Re-sort: bring MATCHED FILTER rows to top first, then other updated rows, then stable
            const matchedRows = rows.filter(r => r.classList.contains('matched-filter') && !r.classList.contains('opacity-60'));
            const updatedRows = rows.filter(r => r.dataset.hasChanged === 'true' && !r.classList.contains('matched-filter') && !r.classList.contains('opacity-60'));
            const stableRows = rows.filter(r => r.dataset.hasChanged !== 'true' && !r.classList.contains('opacity-60'));
            const snoozedRows = rows.filter(r => r.classList.contains('opacity-60'));

            // Collect history rows before clearing tbody
            const historyRows = {};
            document.querySelectorAll('.history-row').forEach(hr => {
                const asin = hr.id.replace('history-row-', '');
                historyRows[asin] = hr;
            });

            tbody.innerHTML = '';
            let index = 1;

            // Helper to append row with its history row
            function appendWithHistory(row) {
                const numCell = row.querySelector('td:nth-child(2)');
                if (numCell) numCell.textContent = index++;
                tbody.appendChild(row);
                // Re-append history row if exists
                const asin = row.getAttribute('data-asin');
                if (asin && historyRows[asin]) {
                    tbody.appendChild(historyRows[asin]);
                }
            }

            // Add matched filter rows first (highlighted in orange)
            matchedRows.forEach(appendWithHistory);

            // Then other updated rows
            updatedRows.forEach(appendWithHistory);

            // Then stable rows
            stableRows.forEach(appendWithHistory);

            // Finally snoozed rows
            snoozedRows.forEach(appendWithHistory);

            // Update the count display if there's a filter
            if (hasFilter) {
                const matchCount = matchedRows.length;
                const countEl = document.getElementById('dateRangeLabel');
                if (matchCount > 0) {
                    countEl.innerHTML = countEl.textContent + ` <span class="bg-orange-600 text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold">${matchCount}</span>`;
                }
            }
        }

        // Legacy function for compatibility
        function applyUpdateRangeFilter() {
            applyDateRangeFilter();
        }

        // === SERVER-SIDE SORTING & FILTERING FUNCTIONS ===
        function sortColumn(column) {
            const url = new URL(window.location);
            const currentSort = url.searchParams.get('sortBy');
            const currentDir = url.searchParams.get('sortDir') || 'asc';

            if (currentSort === column) {
                url.searchParams.set('sortDir', currentDir === 'asc' ? 'desc' : 'asc');
            } else {
                url.searchParams.set('sortBy', column);
                url.searchParams.set('sortDir', 'asc');
            }

            window.location.href = url.toString();
        }

        function updateStatusFilterServer(event) {
            event.stopPropagation();

            const allCheckbox = document.querySelector('.status-checkbox[value="all"]');
            const checkboxes = document.querySelectorAll('.status-checkbox:not([value="all"])');

            if (event.target.value === 'all') {
                checkboxes.forEach(cb => cb.checked = false);
            } else {
                allCheckbox.checked = false;
            }

            applyStatusFilterServer();
        }

        function applyStatusFilterServer() {
            const checkboxes = document.querySelectorAll('.status-checkbox:checked:not([value="all"])');
            const selectedStatuses = Array.from(checkboxes).map(cb => cb.value);

            const url = new URL(window.location);

            if (selectedStatuses.length > 0) {
                url.searchParams.set('filterStatus', selectedStatuses.join(','));
            } else {
                url.searchParams.delete('filterStatus');
            }

            window.location.href = url.toString();
        }

        function applySellerFilterServer() {
            const seller = document.getElementById('sellerFilter').value;
            const url = new URL(window.location);

            if (seller === 'all') {
                url.searchParams.delete('filterSeller');
            } else {
                url.searchParams.set('filterSeller', seller);
            }

            window.location.href = url.toString();
        }

        // Initialize search input with URL param value
        document.addEventListener('DOMContentLoaded', function() {
            const url = new URL(window.location);
            const searchParam = url.searchParams.get('search');
            if (searchParam) {
                const searchInput = document.getElementById('searchInput');
                if (searchInput) searchInput.value = searchParam;
            }
        });
    </script>

    <!-- CSV Column Selection Modal -->
    <div id="csvColumnModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-black text-slate-900">Export to CSV</h2>
                <button onclick="CSVExport.closeColumnSelector()" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            <p class="text-sm text-slate-600 mb-4">Select the columns you want to include in your CSV export. The export will include only the currently visible/filtered rows.</p>
            <div class="flex gap-2 mb-4">
                <button onclick="CSVExport.toggleAllColumns(true)" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-medium hover:bg-blue-200 text-sm">Select All</button>
                <button onclick="CSVExport.toggleAllColumns(false)" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 text-sm">Deselect All</button>
            </div>
            <div id="csvColumnCheckboxes" class="border border-slate-200 rounded-lg p-2 max-h-80 overflow-y-auto mb-6 grid grid-cols-2 gap-1"></div>
            <div class="flex gap-3">
                <button onclick="CSVExport.closeColumnSelector()" class="flex-1 px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-300">Cancel</button>
                <button onclick="CSVExport.exportSelectedColumns()" class="flex-1 px-6 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700">Export CSV</button>
            </div>
        </div>
    </div>
    <script src="/csv-export.js"></script>
</body>
</html>
